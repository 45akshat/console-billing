<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>FIFA Tournament Rating System</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet" />
  <script src="https://cdn.jsdelivr.net/npm/axios/dist/axios.min.js"></script>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
  <style>
    :root {
      --fifa-dark: #0a2240;
      --fifa-blue: #1e90ff;
      --fifa-gold: #ffd700;
      --fifa-green: #2e8b57;
      --fifa-red: #dc143c;
      --fifa-white: #ffffff;
      --fifa-light: #f0f8ff;
    }
    
    body {
      font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
      background: linear-gradient(135deg, #0a2240 0%, #1e3a5f 100%);
      color: var(--fifa-white);
      min-height: 100vh;
      padding-bottom: 2rem;
    }
    
    .container {
      max-width: 1200px;
    }
    
    /* Header Styles */
    .header-container {
      background: linear-gradient(to right, var(--fifa-dark), #0d4a82);
      border-radius: 12px;
      padding: 1.5rem;
      margin-bottom: 2rem;
      box-shadow: 0 8px 20px rgba(0, 0, 0, 0.5);
      position: relative;
      overflow: hidden;
    }
    
    .header-container::before {
      content: "";
      position: absolute;
      top: -50px;
      right: -50px;
      width: 200px;
      height: 200px;
      background: radial-gradient(circle, rgba(30, 144, 255, 0.2) 0%, transparent 70%);
      border-radius: 50%;
    }
    
    .header-container h2 {
      font-weight: 800;
      font-size: 2.5rem;
      text-shadow: 0 2px 4px rgba(0, 0, 0, 0.5);
      letter-spacing: 1px;
      position: relative;
      z-index: 2;
    }
    
    .fifa-logo {
      display: inline-block;
      width: 60px;
      height: 60px;
      background: var(--fifa-gold);
      border-radius: 50%;
      display: flex;
      align-items: center;
      justify-content: center;
      margin-right: 15px;
      box-shadow: 0 4px 8px rgba(0, 0, 0, 0.3);
    }
    
    .fifa-logo i {
      color: var(--fifa-dark);
      font-size: 28px;
    }
    
    /* Connection Status */
    #connectionStatus {
      background: rgba(255, 255, 255, 0.1);
      border: 1px solid rgba(255, 255, 255, 0.2);
      border-radius: 8px;
      padding: 1rem;
      backdrop-filter: blur(5px);
    }
    
    /* Alert Messages */
    #alertContainer .alert {
      background: rgba(255, 255, 255, 0.15);
      border: 1px solid rgba(255, 255, 255, 0.2);
      backdrop-filter: blur(5px);
      color: white;
    }
    
    /* Previous Data Container */
    .previous-data-container {
      background: rgba(10, 34, 64, 0.7);
      border-radius: 12px;
      margin-top: 15px;
      padding: 20px;
      border: 1px solid rgba(30, 144, 255, 0.3);
      box-shadow: 0 4px 12px rgba(0, 0, 0, 0.3);
    }
    
    .previous-data-container h6 {
      color: var(--fifa-gold);
      font-weight: 700;
      margin-bottom: 15px;
      text-align: center;
    }
    
    /* Player History Card */
    .player-history-card {
      background: rgba(255, 255, 255, 0.08);
      border-radius: 10px;
      overflow: hidden;
      transition: transform 0.3s ease, box-shadow 0.3s ease;
      border: 1px solid rgba(255, 255, 255, 0.1);
    }
    
    .player-history-card:hover {
      transform: translateY(-5px);
      box-shadow: 0 6px 15px rgba(0, 0, 0, 0.4);
      border-color: var(--fifa-blue);
    }
    
    .player-history-card .card-header {
      background: linear-gradient(to right, var(--fifa-dark), #0d4a82);
      padding: 12px 15px;
      border-bottom: 2px solid var(--fifa-gold);
    }
    
    .player-history-card .card-body {
      padding: 15px;
      color: white;
    }
    
    .player-history-card li {
      margin-bottom: 8px;
      padding-left: 20px;
      position: relative;
    }
    
    .player-history-card li::before {
      content: "●";
      color: var(--fifa-gold);
      position: absolute;
      left: 5px;
      top: 2px;
    }
    
    /* Match Form */
    .card {
      background: rgba(10, 34, 64, 0.85);
      border-radius: 12px;
      border: 1px solid rgba(30, 144, 255, 0.3);
      box-shadow: 0 8px 20px rgba(0, 0, 0, 0.4);
      overflow: hidden;
    }
    
    .card-header {
      background: linear-gradient(to right, var(--fifa-dark), #0d4a82);
      padding: 15px 20px;
      border-bottom: 2px solid var(--fifa-gold);
    }
    
    .card-header h5 {
      font-weight: 700;
      color: var(--fifa-gold);
      margin: 0;
    }
    
    .card-body {
      padding: 25px;
    }
    
    /* Player Cards */
    .player-card {
      background: rgba(255, 255, 255, 0.08);
      border-radius: 10px;
      padding: 20px;
      transition: all 0.3s ease;
      border: 2px solid transparent;
    }
    
    .player-card:hover {
      border-color: var(--fifa-blue);
      background: rgba(255, 255, 255, 0.12);
    }
    
    .player-card h6 {
      color: var(--fifa-gold);
      font-weight: 700;
      margin-bottom: 15px;
      text-align: center;
      padding-bottom: 10px;
      border-bottom: 1px solid rgba(255, 255, 255, 0.2);
    }
    
    /* VS Divider */
    .vs-divider {
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 2.5rem;
      font-weight: 800;
      color: var(--fifa-gold);
      text-shadow: 0 0 10px rgba(255, 215, 0, 0.7);
      position: relative;
    }
    
    .vs-divider::before, .vs-divider::after {
      content: "";
      flex: 1;
      height: 2px;
      background: linear-gradient(to right, transparent, var(--fifa-gold), transparent);
    }
    
    .vs-divider span {
      padding: 0 20px;
      position: relative;
      z-index: 2;
    }
    
    /* Form Controls */
    .form-label {
      font-weight: 600;
      color: var(--fifa-gold);
      margin-bottom: 8px;
    }
    
    .form-control {
      background: rgba(255, 255, 255, 0.1);
      border: 1px solid rgba(255, 255, 255, 0.2);
      color: white;
      border-radius: 8px;
      padding: 10px 15px;
      transition: all 0.3s ease;
    }
    
    .form-control:focus {
      background: rgba(255, 255, 255, 0.15);
      border-color: var(--fifa-blue);
      box-shadow: 0 0 0 0.25rem rgba(30, 144, 255, 0.25);
      color: white;
    }
    
    .form-control::placeholder {
      color: rgba(255, 255, 255, 0.5);
    }
    
    .form-control.is-valid {
      border-color: var(--fifa-green) !important;
      background: rgba(46, 139, 87, 0.1) !important;
    }
    
    .form-control.is-invalid {
      border-color: var(--fifa-red) !important;
      background: rgba(220, 20, 60, 0.1) !important;
    }
    
    /* Stats Card */
    .stats-card {
      background: rgba(30, 144, 255, 0.15);
      border-left: 3px solid var(--fifa-blue);
      padding: 15px;
      border-radius: 8px;
      margin: 15px 0;
    }
    
    /* Load Both Button */
    .load-both-btn {
      background: linear-gradient(to right, #0a2240, #0d4a82);
      color: white;
      border: 2px solid var(--fifa-gold);
      border-radius: 50px;
      padding: 10px 25px;
      font-weight: 700;
      transition: all 0.3s ease;
      box-shadow: 0 4px 10px rgba(0, 0, 0, 0.3);
    }
    
    .load-both-btn:hover {
      background: linear-gradient(to right, #0d4a82, #1e90ff);
      transform: translateY(-3px);
      box-shadow: 0 6px 15px rgba(0, 0, 0, 0.4);
    }
    
    /* Parameters Toggle */
    .params-toggle {
      cursor: pointer;
      background: rgba(255, 255, 255, 0.08);
      border-radius: 8px;
      padding: 15px;
      transition: all 0.3s ease;
    }
    
    .params-toggle:hover {
      background: rgba(255, 255, 255, 0.12);
    }
    
    .params-toggle h6 {
      color: var(--fifa-gold);
      margin: 0;
    }
    
    #paramsIcon {
      transition: transform 0.3s ease;
    }
    
    /* Validation Summary */
    #validationSummary {
      background: rgba(220, 20, 60, 0.15);
      border: 1px solid var(--fifa-red);
      border-radius: 8px;
      padding: 15px;
    }
    
    #validationList li {
      color: var(--fifa-red);
      margin-bottom: 5px;
    }
    
    /* Submit Buttons */
    .btn-primary {
      background: linear-gradient(to right, var(--fifa-green), #32cd32);
      border: none;
      border-radius: 50px;
      padding: 10px 30px;
      font-weight: 700;
      transition: all 0.3s ease;
      box-shadow: 0 4px 10px rgba(0, 0, 0, 0.3);
    }
    
    .btn-primary:hover {
      background: linear-gradient(to right, #32cd32, var(--fifa-green));
      transform: translateY(-3px);
      box-shadow: 0 6px 15px rgba(0, 0, 0, 0.4);
    }
    
    .btn-secondary {
      background: linear-gradient(to right, #4a4a4a, #6a6a6a);
      border: none;
      border-radius: 50px;
      padding: 10px 25px;
      font-weight: 700;
      color: white;
    }
    
    .btn-secondary:hover {
      background: linear-gradient(to right, #6a6a6a, #8a8a8a);
    }
    
    /* Result Container */
    .match-result-card {
      background: rgba(10, 34, 64, 0.9);
      border-radius: 15px;
      overflow: hidden;
      margin-top: 30px;
      border: 2px solid var(--fifa-gold);
      box-shadow: 0 10px 30px rgba(0, 0, 0, 0.5);
    }
    
    .match-result-card .card-header {
      background: linear-gradient(to right, var(--fifa-dark), #0d4a82);
      padding: 20px;
      text-align: center;
    }
    
    .match-result-card h5 {
      color: var(--fifa-gold);
      font-weight: 800;
      margin: 0;
    }
    
    /* Match Summary */
    .match-summary {
      text-align: center;
      padding: 25px 0;
      background: rgba(0, 0, 0, 0.2);
      margin: 20px -25px;
    }
    
    .match-summary h4 {
      font-size: 1.8rem;
      margin-bottom: 15px;
      color: var(--fifa-gold);
    }
    
    .match-summary h3 {
      font-size: 3rem;
      font-weight: 800;
      margin: 15px 0;
      color: white;
      text-shadow: 0 0 10px rgba(255, 215, 0, 0.7);
    }
    
    .match-summary h5 {
      font-size: 1.5rem;
      color: var(--fifa-gold);
      margin-top: 10px;
    }
    
    /* Player Result Cards */
    .player-result-card {
      background: rgba(255, 255, 255, 0.08);
      border-radius: 12px;
      overflow: hidden;
      margin: 15px 0;
      border: 1px solid rgba(255, 255, 255, 0.1);
    }
    
    .player-result-card .card-header {
      background: linear-gradient(to right, var(--fifa-dark), #0d4a82);
      padding: 15px;
      text-align: center;
    }
    
    .player-result-card .card-header h6 {
      color: var(--fifa-gold);
      margin: 0;
    }
    
    .rating-change-positive {
      color: var(--fifa-green);
      font-weight: 700;
    }
    
    .rating-change-negative {
      color: var(--fifa-red);
      font-weight: 700;
    }
    
    .badge-success {
      background: var(--fifa-green);
    }
    
    .badge-danger {
      background: var(--fifa-red);
    }
    
    /* Match Analytics */
    .match-analytics-card {
      background: rgba(255, 255, 255, 0.08);
      border-radius: 12px;
      margin-top: 25px;
      border: 1px solid rgba(255, 255, 255, 0.1);
    }
    
    .match-analytics-card .card-header {
      background: linear-gradient(to right, var(--fifa-dark), #0d4a82);
      padding: 12px 15px;
      border-bottom: 2px solid var(--fifa-gold);
    }
    
    .analytics-item {
      padding: 15px;
      text-align: center;
    }
    
    .analytics-item small {
      color: var(--fifa-gold);
      display: block;
      margin-bottom: 8px;
      font-weight: 600;
    }
    
    .analytics-value {
      font-size: 1.2rem;
      font-weight: 700;
      color: white;
    }
    
    /* Footer */
    .footer {
      text-align: center;
      margin-top: 30px;
      color: rgba(255, 255, 255, 0.7);
      font-size: 0.9rem;
    }
    
    /* Responsive adjustments */
    @media (max-width: 768px) {
      .vs-divider {
        font-size: 2rem;
      }
      
      .match-summary h3 {
        font-size: 2.2rem;
      }
      
      .analytics-item {
        margin-bottom: 15px;
      }
    }
    
    /* Animations */
    @keyframes pulse {
      0% { box-shadow: 0 0 0 0 rgba(255, 215, 0, 0.4); }
      70% { box-shadow: 0 0 0 10px rgba(255, 215, 0, 0); }
      100% { box-shadow: 0 0 0 0 rgba(255, 215, 0, 0); }
    }
    
    .pulse {
      animation: pulse 2s infinite;
    }
    
    .fade-in {
      animation: fadeIn 0.5s ease-in;
    }
    
    @keyframes fadeIn {
      from { opacity: 0; transform: translateY(10px); }
      to { opacity: 1; transform: translateY(0); }
    }
  </style>
</head>
<body>
  <div class="container mt-4">
    <div class="row justify-content-center">
      <div class="col-lg-10">
        <!-- Header -->
        <div class="header-container">
          <div class="d-flex align-items-center">
            <div class="fifa-logo">
              <i class="fas fa-futbol"></i>
            </div>
            <h2>FIFA Tournament Rating System</h2>
          </div>
        </div>

        <!-- Connection Status -->
        <div id="connectionStatus" class="alert alert-info text-center">
          <div class="spinner-border spinner-border-sm me-2" role="status"></div>
          Checking backend connection...
        </div>

        <!-- Alert Messages -->
        <div id="alertContainer"></div>

        <!-- Previous Data Container (shows after loading) -->
        <div id="previousDataContainer" class="previous-data-container" style="display: none;">
          <h6>Previous Match History</h6>
          <div id="previousDataContent" class="row">
            <!-- Dynamically populated here -->
          </div>
        </div>

        <!-- Match Form -->
        <div class="card">
          <div class="card-header">
            <h5 class="mb-0">Enter Match Details</h5>
          </div>
          <div class="card-body">
            <form id="matchForm">
              <!-- Load Both Stats Button -->
              <div class="text-center mb-4">
                <button type="button" id="loadBothBtn" class="btn load-both-btn px-4" onclick="loadBothStats()">
                  <i class="fas fa-sync-alt me-2"></i> Load Both Previous Match Data
                </button>
                <small class="d-block text-muted mt-2">Enter emails first to load names, ratings, and stats from DB</small>
              </div>

              <!-- Players Section -->
              <div class="row align-items-start">
                <div class="col-md-5">
                  <div class="player-card">
                    <h6>Player 1</h6>
                    <div class="mb-3">
                      <label class="form-label">Player Name *</label>
                      <input type="text" id="p1" name="p1" class="form-control" placeholder="Auto-filled from DB" required />
                    </div>
                    <div class="mb-3">
                      <label class="form-label">Email *</label>
                      <input type="email" id="P1_email" name="P1_email" class="form-control" placeholder="player1@example.com" required />
                    </div>
                    <!-- Stats Display for Player 1 -->
                    <div id="p1Stats" class="stats-card mb-3" style="display: none;">
                      <small><strong>Previous Stats:</strong> <span id="p1StatsContent">Enter emails and click Load Both</span></small>
                    </div>
                    <div class="mb-3">
                      <label class="form-label">Goals Scored *</label>
                      <input type="number" id="P1_GS" name="P1_GS" class="form-control" min="0" max="50" value="0" placeholder="0" required />
                    </div>
                    <!-- Penalty for Player 1 -->
                    <div class="mb-3" id="p1PenaltyDiv" style="display: none;">
                      <label class="form-label">Penalties *</label>
                      <select id="P1_penalty" name="P1_penalty" class="form-control">
                        <option value="0">0</option>
                        <option value="1">1</option>
                        <option value="2">2</option>
                        <option value="3">3</option>
                        <option value="4">4</option>
                        <option value="5">5</option>
                      </select>
                      <small class="form-text text-muted">Required for tiebreaker if goals are equal</small>
                    </div>
                    <div class="mb-3">
                      <label class="form-label">Current Rating</label>
                      <input type="number" id="P1_Curr" name="P1_Curr" class="form-control" value="1000" step="0.01" placeholder="Auto-filled from DB" readonly />
                    </div>
                  </div>
                </div>

                <div class="col-md-2 vs-divider">
                  <span>VS</span>
                </div>

                <div class="col-md-5">
                  <div class="player-card">
                    <h6>Player 2</h6>
                    <div class="mb-3">
                      <label class="form-label">Player Name *</label>
                      <input type="text" id="p2" name="p2" class="form-control" placeholder="Auto-filled from DB" required />
                    </div>
                    <div class="mb-3">
                      <label class="form-label">Email *</label>
                      <input type="email" id="P2_email" name="P2_email" class="form-control" placeholder="player2@example.com" required />
                    </div>
                    <!-- Stats Display for Player 2 -->
                    <div id="p2Stats" class="stats-card mb-3" style="display: none;">
                      <small><strong>Previous Stats:</strong> <span id="p2StatsContent">Enter emails and click Load Both</span></small>
                    </div>
                    <div class="mb-3">
                      <label class="form-label">Goals Scored *</label>
                      <input type="number" id="P2_GS" name="P2_GS" class="form-control" min="0" max="50" value="0" placeholder="0" required />
                    </div>
                    <!-- Penalty for Player 2 -->
                    <div class="mb-3" id="p2PenaltyDiv" style="display: none;">
                      <label class="form-label">Penalties *</label>
                      <select id="P2_penalty" name="P2_penalty" class="form-control">
                        <option value="0">0</option>
                        <option value="1">1</option>
                        <option value="2">2</option>
                        <option value="3">3</option>
                        <option value="4">4</option>
                        <option value="5">5</option>
                      </select>
                      <small class="form-text text-muted">Required for tiebreaker if goals are equal</small>
                    </div>
                    <div class="mb-3">
                      <label class="form-label">Current Rating</label>
                      <input type="number" id="P2_Curr" name="P2_Curr" class="form-control" value="1000" step="0.01" placeholder="Auto-filled from DB" readonly />
                    </div>
                  </div>
                </div>
              </div>

              <!-- Collapsible Parameters -->
              <div class="card mb-3 mt-4">
                <div class="card-header params-toggle" onclick="toggleParams()">
                  <h6 class="mb-0 d-flex justify-content-between align-items-center">
                    <span><i class="fas fa-sliders-h me-2"></i> Rating Parameters</span>
                    <span id="paramsIcon">▼</span>
                  </h6>
                </div>
                <div id="paramsBody" class="card-body" style="display: none;">
                  <div class="row">
                    <div class="col-md-4 mb-3">
                      <label class="form-label">Lambda (K-factor) *</label>
                      <select id="lambda" name="lambda" class="form-control">
                        <option value="12" selected>Low (12)</option>
                        <option value="20">Medium (20)</option>
                        <option value="28">High (28)</option>
                      </select>
                      <small class="form-text text-muted">Controls rating change magnitude</small>
                    </div>
                    <div class="col-md-4 mb-3">
                      <label class="form-label">Weight Factor (W)</label>
                      <input type="number" id="W" name="W" class="form-control" value="1" min="0.1" max="5" step="0.1" />
                      <small class="form-text text-muted">Match importance multiplier</small>
                    </div>
                    <div class="col-md-4 mb-3">
                      <label class="form-label">Alpha (Goal Margin)</label>
                      <input type="number" id="alpha" name="alpha" class="form-control" value="0.5" min="0" max="1" step="0.01" />
                      <small class="form-text text-muted">Goal difference impact</small>
                    </div>
                  </div>
                </div>
              </div>

              <!-- Validation Summary -->
              <div id="validationSummary" class="alert alert-warning" style="display: none;">
                <h6>Please fix the following issues:</h6>
                <ul id="validationList"></ul>
              </div>

              <!-- Submit Button -->
              <div class="text-center mt-4">
                <button type="button" id="validateBtn" class="btn btn-secondary me-2" onclick="validateForm()">
                  <i class="fas fa-check-circle me-2"></i> Validate Form
                </button>
                <button type="submit" id="submitBtn" class="btn btn-primary px-4">
                  <span id="submitText">Process Match</span>
                  <span id="loadingSpinner" class="spinner-border spinner-border-sm ms-2" style="display: none"></span>
                </button>
              </div>
            </form>
          </div>
        </div>

        <!-- Result Container -->
        <div id="resultContainer" style="display: none"></div>
        
        <!-- Footer -->
        <div class="footer">
          <p>FIFA Tournament Rating System &copy; 2023 | Powered by FIFA Rating Algorithm</p>
        </div>
      </div>
    </div>
  </div>

  <script>
    const API_BASE_URL = "http://localhost:5000/match";
    let loadedPlayerData = { p1: null, p2: null };  // Track loaded data for container

    // Check backend connection
    window.addEventListener("load", async function () {
      const statusEl = document.getElementById("connectionStatus");
      try {
        const response = await axios.get(`${API_BASE_URL}/ping`, { timeout: 5000 });
        if (response.data.success) {
          statusEl.className = "alert alert-success text-center";
          statusEl.innerHTML = '<i class="fas fa-check-circle me-2"></i> Backend connected - Ready to process matches';
        }
      } catch (error) {
        statusEl.className = "alert alert-danger text-center";
        statusEl.innerHTML = '<i class="fas fa-exclamation-triangle me-2"></i> Backend connection failed - Check server';
        console.error("Connection error:", error);
      }

      // Add event listeners for GS inputs to toggle penalties
      document.getElementById('P1_GS').addEventListener('input', checkIfPenaltiesNeeded);
      document.getElementById('P2_GS').addEventListener('input', checkIfPenaltiesNeeded);
    });

    // Function to check if penalties are needed
    function checkIfPenaltiesNeeded() {
      const p1GS = parseInt(document.getElementById('P1_GS').value) || 0;
      const p2GS = parseInt(document.getElementById('P2_GS').value) || 0;
      const showPenalties = p1GS === p2GS;
      document.getElementById('p1PenaltyDiv').style.display = showPenalties ? 'block' : 'none';
      document.getElementById('p2PenaltyDiv').style.display = showPenalties ? 'block' : 'none';
    }

    // Load user stats
    async function loadUserStats(emailFieldId, statsId, contentId, ratingFieldId, nameFieldId) {
      const email = document.getElementById(emailFieldId).value.trim().toLowerCase();
      if (!email || !isValidEmail(email)) {
        showAlert('warning', '<i class="fas fa-exclamation-triangle me-2"></i> Enter a valid email first.');
        return;
      }

      const statsEl = document.getElementById(statsId);
      const contentEl = document.getElementById(contentId);
      const ratingEl = document.getElementById(ratingFieldId);
      const nameEl = document.getElementById(nameFieldId);

      try {
        statsEl.innerHTML = '<div class="text-center"><div class="spinner-border spinner-border-sm me-2" role="status"></div> Loading...</div>';
        statsEl.style.display = 'block';

        const response = await axios.get(`${API_BASE_URL}/user/${email}`, { timeout: 10000 });

        if (response.data.success) {
          const data = response.data.data;
          contentEl.innerHTML = `${data.record} | ${data.gs} GS / ${data.gc} GC | ${data.winPercentage}% Win | Team: ${data.team}`;
          statsEl.innerHTML = `<small><strong>Previous Stats:</strong> ${contentEl.innerHTML}</small>`;
          ratingEl.value = data.rating.toFixed(2);
          if (nameEl) {
            nameEl.value = data.name || '';
            if (data.name) nameEl.classList.add('is-valid');
          }
          if (emailFieldId === 'P1_email') loadedPlayerData.p1 = { email, ...data };
          else if (emailFieldId === 'P2_email') loadedPlayerData.p2 = { email, ...data };
          if (loadedPlayerData.p1 && loadedPlayerData.p2) {
            renderPreviousDataContainer();
          } else if (loadedPlayerData.p1 || loadedPlayerData.p2) {
            renderPreviousDataContainer();
          }
          showAlert('success', `<i class="fas fa-user-check me-2"></i> Loaded previous match data for ${email}`);
        } else {
          statsEl.innerHTML = '<small><strong>Previous Stats:</strong> User not found</small>';
          showAlert('warning', response.data.message || 'User not found');
        }
      } catch (error) {
        statsEl.innerHTML = '<small><strong>Previous Stats:</strong> Error loading</small>';
        let errorMsg = 'Failed to load previous data.';
        if (error.code === 'ECONNABORTED') errorMsg += ' Request timed out.';
        else if (error.response?.status === 404) errorMsg += ' User not found.';
        else if (error.message) errorMsg += ` ${error.message}`;
        showAlert('danger', `<i class="fas fa-exclamation-circle me-2"></i> ${errorMsg}`);
        console.error('Load stats error:', error);
      }
    }

    // Render Previous Data Container
    function renderPreviousDataContainer() {
      const container = document.getElementById('previousDataContainer');
      const content = document.getElementById('previousDataContent');
      let html = '';
      if (loadedPlayerData.p1) {
        const p1 = loadedPlayerData.p1;
        html += `
          <div class="col-md-6">
            <div class="card player-history-card">
              <div class="card-header">
                <h6 class="mb-0">${p1.email} (${p1.name || 'N/A'})</h6>
              </div>
              <div class="card-body">
                <ul class="list-unstyled small">
                  <li><strong>Rating:</strong> ${p1.rating.toFixed(2)}</li>
                  <li><strong>Record:</strong> ${p1.record}</li>
                  <li><strong>GS / GC:</strong> ${p1.gs} / ${p1.gc}</li>
                  <li><strong>Win %:</strong> ${p1.winPercentage}%</li>
                  <li><strong>Team:</strong> ${p1.team}</li>
                </ul>
              </div>
            </div>
          </div>
        `;
      } else {
        html += '<div class="col-md-6"><small class="text-muted">Player 1 data not loaded</small></div>';
      }
      if (loadedPlayerData.p2) {
        const p2 = loadedPlayerData.p2;
        html += `
          <div class="col-md-6">
            <div class="card player-history-card">
              <div class="card-header">
                <h6 class="mb-0">${p2.email} (${p2.name || 'N/A'})</h6>
              </div>
              <div class="card-body">
                <ul class="list-unstyled small">
                  <li><strong>Rating:</strong> ${p2.rating.toFixed(2)}</li>
                  <li><strong>Record:</strong> ${p2.record}</li>
                  <li><strong>GS / GC:</strong> ${p2.gs} / ${p2.gc}</li>
                  <li><strong>Win %:</strong> ${p2.winPercentage}%</li>
                  <li><strong>Team:</strong> ${p2.team}</li>
                </ul>
              </div>
            </div>
          </div>
        `;
      } else {
        html += '<div class="col-md-6"><small class="text-muted">Player 2 data not loaded</small></div>';
      }
      content.innerHTML = html;
      container.style.display = 'block';
    }

    // Load Both Stats Button Handler
    async function loadBothStats() {
      const p1Email = document.getElementById('P1_email').value.trim();
      const p2Email = document.getElementById('P2_email').value.trim();
      if (!p1Email || !p2Email) {
        showAlert('warning', '<i class="fas fa-exclamation-triangle me-2"></i> Enter both emails first to load previous data.');
        return;
      }

      const btn = document.getElementById('loadBothBtn');
      const originalText = btn.innerHTML;
      btn.innerHTML = '<span class="spinner-border spinner-border-sm me-2"></span> Loading Both...';
      btn.disabled = true;

      let errors = [];
      try {
        await loadUserStats('P1_email', 'p1Stats', 'p1StatsContent', 'P1_Curr', 'p1');
      } catch (err) { errors.push('Player 1'); }
      
      try {
        await loadUserStats('P2_email', 'p2Stats', 'p2StatsContent', 'P2_Curr', 'p2');
      } catch (err) { errors.push('Player 2'); }

      if (errors.length === 0) {
        showAlert('success', '<i class="fas fa-users me-2"></i> Loaded previous match data for both players');
      } else {
        showAlert('warning', `<i class="fas fa-exclamation-triangle me-2"></i> Loaded partial data – Failed for ${errors.join(', ')}`);
      }

      btn.innerHTML = originalText;
      btn.disabled = false;
    }

    // Toggle parameters
    function toggleParams() {
      const body = document.getElementById('paramsBody');
      const icon = document.getElementById('paramsIcon');
      body.style.display = body.style.display === 'none' ? 'block' : 'none';
      icon.textContent = body.style.display === 'none' ? '▼' : '▲';
    }

    // Form validation function
    function validateForm() {
      const errors = [];
      const validationSummary = document.getElementById("validationSummary");
      const validationList = document.getElementById("validationList");

      // Required text fields
      const requiredFields = [
        { id: 'p1', name: 'Player 1 Name', minLength: 2 },
        { id: 'p2', name: 'Player 2 Name', minLength: 2 },
        { id: 'P1_email', name: 'Player 1 Email', type: 'email' },
        { id: 'P2_email', name: 'Player 2 Email', type: 'email' }
      ];

      // Required number/select fields
      const requiredNumbers = [
        { id: 'P1_GS', name: 'Player 1 Goals Scored', min: 0, max: 50 },
        { id: 'P2_GS', name: 'Player 2 Goals Scored', min: 0, max: 50 },
        { id: 'W', name: 'Weight Factor', min: 0.1, max: 5 },
        { id: 'alpha', name: 'Alpha', min: 0, max: 1 },
        { id: 'lambda', name: 'Lambda (K-factor)', type: 'select' }
      ];

      // Add penalties if displayed
      if (document.getElementById('p1PenaltyDiv').style.display !== 'none') {
        requiredNumbers.push({ id: 'P1_penalty', name: 'Player 1 Penalties', type: 'select', min: 0, max: 5 });
        requiredNumbers.push({ id: 'P2_penalty', name: 'Player 2 Penalties', type: 'select', min: 0, max: 5 });
      }

      // Validate required text fields
      requiredFields.forEach(field => {
        const element = document.getElementById(field.id);
        const value = element.value.trim();
        
        if (!value) {
          errors.push(`${field.name} is required`);
          element.classList.add('is-invalid');
        } else if (field.minLength && value.length < field.minLength) {
          errors.push(`${field.name} must be at least ${field.minLength} characters`);
          element.classList.add('is-invalid');
        } else if (field.type === 'email' && !isValidEmail(value)) {
          errors.push(`${field.name} must be a valid email address`);
          element.classList.add('is-invalid');
        } else {
          element.classList.remove('is-invalid');
          element.classList.add('is-valid');
        }
      });

      // Validate required number/select fields
      requiredNumbers.forEach(field => {
        const element = document.getElementById(field.id);
        let value;
        if (field.type === 'select') {
          value = parseInt(element.value);
        } else {
          value = parseFloat(element.value);
        }
        
        if (isNaN(value)) {
          errors.push(`${field.name} must be valid`);
          element.classList.add('is-invalid');
        } else if (value < field.min || value > field.max) {
          errors.push(`${field.name} must be between ${field.min} and ${field.max}`);
          element.classList.add('is-invalid');
        } else {
          element.classList.remove('is-invalid');
          element.classList.add('is-valid');
        }
      });

      // Business logic validation
      const p1Name = document.getElementById('p1').value.trim();
      const p2Name = document.getElementById('p2').value.trim();
      const p1Email = document.getElementById('P1_email').value.trim().toLowerCase();
      const p2Email = document.getElementById('P2_email').value.trim().toLowerCase();

      if (p1Name && p2Name && p1Name.toLowerCase() === p2Name.toLowerCase()) {
        errors.push('Player names must be different');
      }

      if (p1Email && p2Email && p1Email === p2Email) {
        errors.push('Player emails must be different');
      }

      // Show/hide validation summary
      if (errors.length > 0) {
        validationList.innerHTML = errors.map(error => `<li>${error}</li>`).join('');
        validationSummary.style.display = 'block';
        validationSummary.scrollIntoView({ behavior: 'smooth' });
        return false;
      } else {
        validationSummary.style.display = 'none';
        showAlert('success', '<i class="fas fa-check-circle me-2"></i> All fields are valid! Ready to process match.');
        return true;
      }
    }

    // Email validation helper
    function isValidEmail(email) {
      const emailRegex = /^[^\s@]+@[^\s@]+\.[^\s@]+$/;
      return emailRegex.test(email);
    }

    // Form submission handler
    document.getElementById("matchForm").addEventListener("submit", async function (e) {
      e.preventDefault();

      if (!validateForm()) {
        return;
      }

      const submitBtn = document.getElementById("submitBtn");
      const submitText = document.getElementById("submitText");
      const loadingSpinner = document.getElementById("loadingSpinner");

      try {
        submitBtn.disabled = true;
        submitText.textContent = "Processing Match...";
        loadingSpinner.style.display = "inline-block";

        document.getElementById("alertContainer").innerHTML = "";

        const formData = {
          p1: document.getElementById("p1").value.trim(),
          p2: document.getElementById("p2").value.trim(),
          P1_email: document.getElementById("P1_email").value.trim().toLowerCase(),
          P2_email: document.getElementById("P2_email").value.trim().toLowerCase(),
          P1_GS: parseInt(document.getElementById("P1_GS").value) || 0,
          P2_GS: parseInt(document.getElementById("P2_GS").value) || 0,
          P1_penalty: parseInt(document.getElementById("P1_penalty").value) || 0,
          P2_penalty: parseInt(document.getElementById("P2_penalty").value) || 0,
          lambda: parseFloat(document.getElementById("lambda").value) || 12,
          W: parseFloat(document.getElementById("W").value) || 1,
          alpha: parseFloat(document.getElementById("alpha").value) || 0.5,
        };

        console.log("Sending match data:", formData);

        const response = await axios.post(`${API_BASE_URL}/process`, formData, {
          headers: { "Content-Type": "application/json" },
          timeout: 30000,
        });

        console.log("Response:", response.data);

        if (response.data.success) {
          showAlert("success", "<i class='fas fa-trophy me-2'></i> Match processed! Stats updated in DB.");
          displayResult(response.data.data, formData);
          document.querySelectorAll('.is-valid, .is-invalid').forEach(el => {
            el.classList.remove('is-valid', 'is-invalid');
          });
        } else {
          showAlert("danger", response.data.message);
        }
      } catch (error) {
        console.error("Error:", error);
        let errorMessage = "Failed to process match. ";
        if (error.response?.data?.message) {
          errorMessage += error.response.data.message;
        } else if (error.message) {
          errorMessage += error.message;
        } else {
          errorMessage += "Unknown error occurred.";
        }
        showAlert("danger", `<i class="fas fa-exclamation-circle me-2"></i> ${errorMessage}`);
      } finally {
        submitBtn.disabled = false;
        submitText.textContent = "Process Match";
        loadingSpinner.style.display = "none";
      }
    });

    // Show alert function
    function showAlert(type, message) {
      const alertHTML = `
        <div class="alert alert-${type} alert-dismissible fade show" role="alert">
          ${message}
          <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
        </div>
      `;
      document.getElementById("alertContainer").innerHTML = alertHTML;
    }

    // Display result function
    function displayResult(result, originalData) {
      const safeValue = (value, defaultValue = 0) => value ?? defaultValue;

      const safeResult = {
        player1: result.player1 || originalData.p1 || 'Player 1',
        player2: result.player2 || originalData.p2 || 'Player 2',
        player1Email: result.player1Email || originalData.P1_email || '',
        player2Email: result.player2Email || originalData.P2_email || '',
        winner: result.winner || 'Unknown',
        player1CurrentRating: safeValue(result.player1CurrentRating, 1000),
        player2CurrentRating: safeValue(result.player2CurrentRating, 1000),
        player1NewRating: safeValue(result.player1NewRating, 1000),
        player2NewRating: safeValue(result.player2NewRating, 1000),
        player1RatingChange: safeValue(result.player1RatingChange, 0),
        player2RatingChange: safeValue(result.player2RatingChange, 0),
        player1ExpectedScore: safeValue(result.player1ExpectedScore, 0.5),
        player2ExpectedScore: safeValue(result.player2ExpectedScore, 0.5),
        goalMargin: safeValue(result.goalMargin, 0),
        lambda: safeValue(result.lambda, originalData.lambda),
        weightFactor: safeValue(result.weightFactor, originalData.W),
        alpha: safeValue(result.alpha, originalData.alpha),
        p1UpdatedStats: result.p1UpdatedStats || { gs: 0, gc: 0, mp: 0, mw: 0, winPercentage: '0.00', team: 'Free Agent', record: '0W-0L' },
        p2UpdatedStats: result.p2UpdatedStats || { gs: 0, gc: 0, mp: 0, mw: 0, winPercentage: '0.00', team: 'Free Agent', record: '0W-0L' },
        isPenalty: result.isPenalty || false,
        p1Penalty: safeValue(result.p1Penalty, 0),
        p2Penalty: safeValue(result.p2Penalty, 0)
      };

      let scoreLine = `${originalData.P1_GS}-${originalData.P2_GS}`;
      if (safeResult.isPenalty) {
        scoreLine += ` (${safeResult.p1Penalty}-${safeResult.p2Penalty} pens)`;
      }

      const resultHTML = `
        <div class="card mt-4 match-result-card fade-in">
          <div class="card-header">
            <h5 class="mb-0"><i class="fas fa-trophy me-2"></i> Match Result</h5>
          </div>
          <div class="card-body">
            <!-- Match Summary -->
            <div class="match-summary">
              <h4>${safeResult.player1} vs ${safeResult.player2}</h4>
              <h3 class="pulse">${scoreLine}</h3>
              <h5>Winner: ${safeResult.winner}</h5>
            </div>
            
            <!-- Rating Changes -->
            <div class="row">
              <div class="col-md-6">
                <div class="player-result-card">
                  <div class="card-header">
                    <h6 class="mb-0">${safeResult.player1}</h6>
                    <small>${safeResult.player1Email}</small>
                  </div>
                  <div class="card-body text-center">
                    <div class="row">
                      <div class="col-6">
                        <small class="text-muted">Previous Rating</small>
                        <h5>${safeResult.player1CurrentRating.toFixed(2)}</h5>
                      </div>
                      <div class="col-6">
                        <small class="text-muted">New Rating</small>
                        <h5 class="rating-change-${safeResult.player1RatingChange >= 0 ? "positive" : "negative"}">
                          ${safeResult.player1NewRating.toFixed(2)}
                        </h5>
                      </div>
                    </div>
                    <div class="mt-3">
                      <span class="badge bg-${safeResult.player1RatingChange >= 0 ? "success" : "danger"}">
                        ${safeResult.player1RatingChange >= 0 ? "+" : ""}${safeResult.player1RatingChange.toFixed(2)}
                      </span>
                    </div>
                  </div>
                </div>
                <!-- Updated Stats for Player 1 -->
                <div class="player-result-card mt-3">
                  <div class="card-header">
                    <small>Updated Stats</small>
                  </div>
                  <div class="card-body small">
                    ${safeResult.p1UpdatedStats.record} | ${safeResult.p1UpdatedStats.gs} GS (+${originalData.P1_GS}) / ${safeResult.p1UpdatedStats.gc} GC (+${originalData.P2_GS}) | ${safeResult.p1UpdatedStats.winPercentage}% Win | Team: ${safeResult.p1UpdatedStats.team}
                  </div>
                </div>
              </div>
              
              <div class="col-md-6">
                <div class="player-result-card">
                  <div class="card-header">
                    <h6 class="mb-0">${safeResult.player2}</h6>
                    <small>${safeResult.player2Email}</small>
                  </div>
                  <div class="card-body text-center">
                    <div class="row">
                      <div class="col-6">
                        <small class="text-muted">Previous Rating</small>
                        <h5>${safeResult.player2CurrentRating.toFixed(2)}</h5>
                      </div>
                      <div class="col-6">
                        <small class="text-muted">New Rating</small>
                        <h5 class="rating-change-${safeResult.player2RatingChange >= 0 ? "positive" : "negative"}">
                          ${safeResult.player2NewRating.toFixed(2)}
                        </h5>
                      </div>
                    </div>
                    <div class="mt-3">
                      <span class="badge bg-${safeResult.player2RatingChange >= 0 ? "success" : "danger"}">
                        ${safeResult.player2RatingChange >= 0 ? "+" : ""}${safeResult.player2RatingChange.toFixed(2)}
                      </span>
                    </div>
                  </div>
                </div>
                <!-- Updated Stats for Player 2 -->
                <div class="player-result-card mt-3">
                  <div class="card-header">
                    <small>Updated Stats</small>
                  </div>
                  <div class="card-body small">
                    ${safeResult.p2UpdatedStats.record} | ${safeResult.p2UpdatedStats.gs} GS (+${originalData.P2_GS}) / ${safeResult.p2UpdatedStats.gc} GC (+${originalData.P1_GS}) | ${safeResult.p2UpdatedStats.winPercentage}% Win | Team: ${safeResult.p2UpdatedStats.team}
                  </div>
                </div>
              </div>
            </div>
            
            <!-- Match Analytics -->
            <div class="match-analytics-card">
              <div class="card-header">
                <h6 class="mb-0"><i class="fas fa-chart-line me-2"></i> Match Analytics</h6>
              </div>
              <div class="card-body">
                <div class="row text-center">
                  <div class="col-md-3 analytics-item">
                    <small>Expected Scores</small>
                    <div class="analytics-value">P1: ${(safeResult.player1ExpectedScore * 100).toFixed(1)}%</div>
                    <div class="analytics-value">P2: ${(safeResult.player2ExpectedScore * 100).toFixed(1)}%</div>
                  </div>
                  <div class="col-md-3 analytics-item">
                    <small>Goal Margin Impact</small>
                    <div class="analytics-value">${safeResult.goalMargin.toFixed(3)}</div>
                  </div>
                  <div class="col-md-2 analytics-item">
                    <small>Lambda (K)</small>
                    <div class="analytics-value">${safeResult.lambda}</div>
                  </div>
                  <div class="col-md-2 analytics-item">
                    <small>Weight (W)</small>
                    <div class="analytics-value">${safeResult.weightFactor}</div>
                  </div>
                  <div class="col-md-2 analytics-item">
                    <small>Alpha (α)</small>
                    <div class="analytics-value">${safeResult.alpha}</div>
                  </div>
                </div>
              </div>
            </div>
            
            <!-- Action Buttons -->
            <div class="text-center mt-4">
              <button class="btn btn-primary me-2" onclick="resetForm()">
                <i class="fas fa-plus-circle me-2"></i> Process Another Match
              </button>
              <button class="btn btn-outline-light" onclick="downloadResult()">
                <i class="fas fa-download me-2"></i> Download Result
              </button>
            </div>
          </div>
        </div>
      `;

      const resultContainer = document.getElementById("resultContainer");
      resultContainer.innerHTML = resultHTML;
      resultContainer.style.display = "block";

      setTimeout(() => {
        resultContainer.scrollIntoView({ behavior: "smooth" });
      }, 100);

      window.lastResult = safeResult;
    }

    // Reset form
    function resetForm() {
      document.getElementById("matchForm").reset();
      document.getElementById("lambda").value = "12";
      document.getElementById("W").value = 1;
      document.getElementById("alpha").value = 0.5;
      document.getElementById("P1_GS").value = 0;
      document.getElementById("P2_GS").value = 0;
      document.getElementById("P1_penalty").value = 0;
      document.getElementById("P2_penalty").value = 0;
      document.getElementById("P1_Curr").value = 1000;
      document.getElementById("P2_Curr").value = 1000;
      document.querySelectorAll('.is-valid, .is-invalid').forEach(el => {
        el.classList.remove('is-valid', 'is-invalid');
      });
      document.getElementById("validationSummary").style.display = 'none';
      document.getElementById("p1Stats").style.display = 'none';
      document.getElementById("p2Stats").style.display = 'none';
      document.getElementById("previousDataContainer").style.display = 'none';
      loadedPlayerData = { p1: null, p2: null };
      checkIfPenaltiesNeeded();
      window.scrollTo({ top: 0, behavior: "smooth" });
    }

    // Download result
    function downloadResult() {
      if (window.lastResult) {
        const dataStr = "data:text/json;charset=utf-8," + encodeURIComponent(JSON.stringify(window.lastResult, null, 2));
        const downloadAnchorNode = document.createElement("a");
        downloadAnchorNode.setAttribute("href", dataStr);
        downloadAnchorNode.setAttribute("download", `fifa_match_result_${Date.now()}.json`);
        document.body.appendChild(downloadAnchorNode);
        downloadAnchorNode.click();
        downloadAnchorNode.remove();
      }
    }
  </script>

  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>
</body>
</html>