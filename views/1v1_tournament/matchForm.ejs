<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>FIFA Tournament Rating System</title>
    <link
      href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css"
      rel="stylesheet"
    />
    <script src="https://cdn.jsdelivr.net/npm/axios/dist/axios.min.js"></script>
    <link
      rel="stylesheet"
      href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css"
    />
    <style>
      :root {
        --fifa-dark: #0a2240;
        --fifa-blue: #1e90ff;
        --fifa-gold: #ffd700;
        --fifa-green: #2e8b57;
        --fifa-red: #dc143c;
        --fifa-white: #ffffff;
        --fifa-light: #f0f8ff;
        --card-bg: #1a2b4a;
        --highlight-bg: #2a3b5a;
        --primary-gradient: linear-gradient(135deg, #6a11cb 0%, #2575fc 100%);
        --secondary-gradient: linear-gradient(135deg, #8e2de2 0%, #4a00e0 100%);
      }

      body {
        font-family: "Segoe UI", Tahoma, Geneva, Verdana, sans-serif;
        background: url("https://framerusercontent.com/images/ivawcO0RkSFFfT2mL6vMfFXqFrA.png?width=325&height=238")
          center/cover no-repeat fixed;
        color: white;
        min-height: 100vh;
        padding-bottom: 2rem;
        margin: 0;
        display: flex;
      }

      /* Sidebar Styles */
      .side-menu {
        position: fixed;
        top: 0;
        left: 0;
        width: 200px;
        height: 100%;
        background: #333;
        color: #fff;
        padding: 20px;
        z-index: 1000;
      }

      .side-menu nav ul {
        list-style: none;
        padding: 0;
        margin: 0;
      }

      .side-menu nav ul li {
        margin-bottom: 10px;
      }

      .side-menu nav ul li a {
        color: #fff;
        text-decoration: none;
        display: flex;
        align-items: center;
        padding: 10px;
        border-radius: 5px;
        transition: background-color 0.3s;
      }

      .side-menu nav ul li a:hover {
        background-color: #555;
      }

      .side-menu nav ul li a i {
        margin-right: 10px;
      }

      .side-menu nav ul li a.active {
        font-weight: bold;
        background-color: #007bff;
      }

      /* Main content adjustment for sidebar */
      .main-content {
        margin-left: 220px;
        flex-grow: 1;
        padding: 20px;
      }

      .container {
        max-width: 1200px;
      }

      /* Header Styles */
      .header-container {
        background: url("https://futfc.gg/wp-content/uploads/2025/04/Gn9gqiiWoAAv77l.webp")
          center/cover no-repeat;
        border-radius: 12px;
        padding: 1.5rem;
        margin-bottom: 2rem;
        box-shadow: 0 8px 20px rgba(0, 0, 0, 0.5);
        position: relative;
        overflow: hidden;
        min-height: 120px;
        display: flex;
        align-items: center;
        justify-content: center;
      }

      .header-container h2 {
        font-weight: 800;
        font-size: 2.5rem;
        text-shadow: 0 2px 4px rgba(0, 0, 0, 0.5);
        letter-spacing: 1px;
        position: relative;
        z-index: 2;
      }

      /* Step Containers */
      .step-container {
        background: rgba(10, 34, 64, 0.85);
        border-radius: 12px;
        border: 1px solid rgba(30, 144, 255, 0.3);
        box-shadow: 0 8px 20px rgba(0, 0, 0, 0.4);
        overflow: hidden;
        margin-bottom: 1.5rem;
        transition: all 0.3s ease;
      }

      .step-header {
        background: var(--primary-gradient);
        padding: 15px 20px;
        border-bottom: 2px solid var(--fifa-gold);
      }

      .step-header h5 {
        font-weight: 700;
        color: white;
        margin: 0;
      }

      .step-body {
        padding: 25px;
      }

      /* Form Controls */
      .form-label {
        font-weight: 600;
        color: white;
        margin-bottom: 8px;
      }

      .form-control {
        background: rgba(255, 255, 255, 0.9) !important;
        border: 1px solid rgba(30, 144, 255, 0.3);
        color: #000 !important;
        border-radius: 0.5rem;
        padding: 10px 15px;
        transition: all 0.3s ease;
      }

      .form-control:focus {
        background: #fff !important;
        border-color: var(--fifa-blue);
        box-shadow: 0 0 0 0.25rem rgba(30, 144, 255, 0.25);
      }

      select.form-control {
        color: #000 !important;
      }

      select.form-control option {
        background: #fff;
        color: #000;
      }

      /* Player Cards */
      .player-card {
        background: var(--card-bg);
        border-radius: 10px;
        padding: 20px;
        transition: all 0.3s ease;
        border: 2px solid transparent;
        margin-bottom: 20px;
      }

      .player-card:hover {
        border-color: var(--fifa-blue);
      }

      .player-card h6 {
        color: white;
        font-weight: 700;
        margin-bottom: 20px;
        text-align: center;
        padding-bottom: 10px;
        border-bottom: 1px solid rgba(255, 255, 255, 0.2);
        background: var(--secondary-gradient);
        padding: 10px;
        border-radius: 8px;
      }

      /* Player Info */
      .player-info {
        background: rgba(255, 255, 255, 0.1);
        border-radius: 8px;
        padding: 15px;
        margin-bottom: 15px;
      }

      .player-info-row {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 10px;  
      }

      .player-info-label {
        color: rgba(255, 255, 255, 0.8);
        font-size: 0.9rem;
      }

      .player-info-value {
        color: white;
        font-weight: 600;
      }

      .player-rating {
        color: var(--fifa-gold) !important;
      }

      /* Rating Display */
      .rating-display {
        text-align: center;
        margin-bottom: 20px;
      }

      .rating-value {
        font-size: 2.5rem;
        font-weight: 800;
        color: var(--fifa-gold);
        margin-bottom: 5px;
      }

      .rating-label {
        font-size: 1rem;
        color: rgba(255, 255, 255, 0.8);
      }

      .star-icon {
        color: var(--fifa-gold);
        font-size: 2rem;
        margin-bottom: 10px;
      }

      /* Stats Card */
      .stats-card {
        background: rgba(255, 255, 255, 0.1);
        border-radius: 8px;
        padding: 15px;
        margin-bottom: 15px;
      }

      .stats-label {
        color: rgba(255, 255, 255, 0.8);
        margin-bottom: 10px;
        font-size: 0.9rem;
        text-align: center;
      }

      .stats-grid {
        display: grid;
        grid-template-columns: repeat(2, 1fr);
        gap: 10px;
        margin-top: 10px;
      }

      .stat-box {
        background: rgba(0, 0, 0, 0.3);
        border-radius: 6px;
        padding: 10px;
        text-align: center;
      }

      /* Make the last box (Team Name) span across both columns */
      .stat-box:last-child {
        grid-column: span 2;
      }

      .stat-value {
        font-size: 1.2rem;
        font-weight: 700;
        color: white;
      }

      .stat-label {
        font-size: 0.8rem;
        color: rgba(255, 255, 255, 0.7);
        margin-top: 5px;
      }

      /* Available Cards */
      .cards-container {
        display: grid;
        grid-template-columns: repeat(auto-fill, minmax(250px, 1fr));
        gap: 10px;
        margin-top: 10px;
      }

      .card-selectable {
        background: rgba(0, 0, 0, 0.3);
        border-radius: 8px;
        padding: 15px;
        transition: all 0.3s ease;
        border: 2px solid transparent;
        cursor: pointer;
        position: relative;
      }

      .card-selectable:hover {
        background: rgba(0, 0, 0, 0.4);
      }

      .card-selectable.selected {
        border-color: var(--fifa-blue);
        background: var(--highlight-bg);
        box-shadow: 0 0 15px rgba(30, 144, 255, 0.5);
      }

      .card-title {
        font-weight: 600;
        margin-bottom: 8px;
        color: white;
      }

      .card-code {
        font-family: "Courier New", monospace;
        font-weight: 600;
        background: rgba(255, 255, 255, 0.1);
        padding: 3px 8px;
        border-radius: 4px;
        display: inline-block;
        margin-bottom: 8px;
      }

      .card-expiry {
        color: rgba(255, 255, 255, 0.7);
        font-size: 0.85rem;
        margin-bottom: 5px;
      }

      .card-days {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-top: 10px;
      }

      .days-badge {
        font-size: 0.8rem;
        padding: 3px 8px;
        border-radius: 10px;
      }

      .days-danger {
        background: var(--fifa-red);
      }

      .days-warning {
        background: #ffa500;
      }

      .days-success {
        background: var(--fifa-green);
      }

      /* Custom Checkbox */
      .custom-checkbox {
        position: absolute;
        top: 10px;
        right: 10px;
        width: 24px;
        height: 24px;
        border-radius: 50%;
        background: rgba(255, 255, 255, 0.2);
        border: 2px solid rgba(255, 255, 255, 0.5);
        display: flex;
        align-items: center;
        justify-content: center;
        transition: all 0.3s ease;
        box-shadow: 0 2px 5px rgba(0, 0, 0, 0.3);
      }

      .card-selectable.selected .custom-checkbox {
        background: var(--fifa-blue);
        border-color: var(--fifa-blue);
        box-shadow: 0 0 10px rgba(30, 144, 255, 0.8);
      }

      .custom-checkbox i {
        color: white;
        font-size: 12px;
        opacity: 0;
        transition: opacity 0.3s ease;
      }

      .card-selectable.selected .custom-checkbox i {
        opacity: 1;
      }

      /* Selected Card Info */
      .selected-card-info {
        background: rgba(0, 123, 255, 0.2);
        border: 1px solid rgba(0, 123, 255, 0.5);
        border-radius: 8px;
        padding: 12px;
        margin-top: 15px;
      }

      /* VS Divider */
      .vs-divider {
        display: flex;
        align-items: center;
        justify-content: center;
        font-size: 2.5rem;
        font-weight: 800;
        color: var(--fifa-gold);
        text-shadow: 0 0 10px rgba(255, 215, 0, 0.7);
        position: relative;
        height: 100%;
      }

      .vs-divider::before,
      .vs-divider::after {
        content: "";
        flex: 1;
        height: 2px;
        background: linear-gradient(
          to right,
          transparent,
          var(--fifa-gold),
          transparent
        );
      }

      .vs-divider span {
        padding: 0 20px;
        position: relative;
        z-index: 2;
      }

      /* Buttons */
      .btn-primary {
        background: var(--primary-gradient);
        border: none;
        border-radius: 0.5rem;
        padding: 10px 30px;
        font-weight: 700;
        transition: all 0.3s ease;
        box-shadow: 0 4px 10px rgba(0, 0, 0, 0.3);
        color: white;
      }

      .btn-primary:hover {
        background: var(--secondary-gradient);
        transform: translateY(-3px);
        box-shadow: 0 6px 15px rgba(0, 0, 0, 0.4);
        color: white;
      }

      .load-btn {
        background: var(--primary-gradient);
        color: white;
        border: none;
        border-radius: 0.5rem;
        padding: 10px 25px;
        font-weight: 700;
        transition: all 0.3s ease;
        box-shadow: 0 4px 10px rgba(0, 0, 0, 0.3);
      }

      .load-btn:hover {
        background: var(--secondary-gradient);
        transform: translateY(-3px);
        box-shadow: 0 6px 15px rgba(0, 0, 0, 0.4);
      }

      /* Alerts */
      .alert {
        border-radius: 8px;
        background: rgba(255, 255, 255, 0.15);
        border: 1px solid rgba(255, 255, 255, 0.2);
        backdrop-filter: blur(5px);
        color: white;
      }

      /* Result Container */
      .match-result-card {
        background: rgba(10, 34, 64, 0.9);
        border-radius: 15px;
        overflow: hidden;
        margin-top: 30px;
        border: 2px solid var(--fifa-gold);
        box-shadow: 0 10px 30px rgba(0, 0, 0, 0.5);
      }

      .match-result-card .card-header {
        background: var(--primary-gradient);
        padding: 20px;
        text-align: center;
      }

      .match-result-card h5 {
        color: var(--fifa-gold);
        font-weight: 800;
        margin: 0;
      }

      /* Match Summary */
      .match-summary {
        text-align: center;
        padding: 25px 0;
        background: rgba(0, 0, 0, 0.2);
        margin: 20px -25px;
      }

      .match-summary h4 {
        font-size: 1.8rem;
        margin-bottom: 15px;
        color: var(--fifa-gold);
      }

      .match-summary h3 {
        font-size: 3rem;
        font-weight: 800;
        margin: 15px 0;
        color: white;
        text-shadow: 0 0 10px rgba(255, 215, 0, 0.7);
      }

      .match-summary h5 {
        font-size: 1.5rem;
        color: var(--fifa-gold);
        margin-top: 10px;
      }

      /* Player Result Cards */
      .player-result-card {
        background: rgba(255, 255, 255, 0.08);
        border-radius: 12px;
        overflow: hidden;
        margin: 15px 0;
        border: 1px solid rgba(255, 255, 255, 0.1);
      }

      .player-result-card .card-header {
        background: var(--primary-gradient);
        padding: 15px;
        text-align: center;
      }

      .player-result-card .card-header h6 {
        color: var(--fifa-gold);
        margin: 0;
      }

      .rating-change-positive {
        color: var(--fifa-green);
        font-weight: 700;
      }

      .rating-change-negative {
        color: var(--fifa-red);
        font-weight: 700;
      }

      .badge-success {
        background: var(--fifa-green);
      }

      .badge-danger {
        background: var(--fifa-red);
      }

      /* Match Result Text Colors */
      .match-result-card .text-muted,
      .match-result-card small,
      .player-result-card .text-muted,
      .player-result-card small,
      .player-result-card .card-body {
        color: white !important;
      }

      .player-result-card .card-body.small {
        color: white !important;
      }

      /* Animations */
      @keyframes pulse {
        0% {
          box-shadow: 0 0 0 0 rgba(255, 215, 0, 0.4);
        }
        70% {
          box-shadow: 0 0 0 10px rgba(255, 215, 0, 0);
        }
        100% {
          box-shadow: 0 0 0 0 rgba(255, 215, 0, 0);
        }
      }

      .pulse {
        animation: pulse 2s infinite;
      }

      .fade-in {
        animation: fadeIn 0.5s ease-in;
      }

      @keyframes fadeIn {
        from {
          opacity: 0;
          transform: translateY(10px);
        }
        to {
          opacity: 1;
          transform: translateY(0);
        }
      }

      /* Responsive adjustments */
      @media (max-width: 768px) {
        .vs-divider {
          font-size: 2rem;
          margin: 20px 0;
        }

        .match-summary h3 {
          font-size: 2.2rem;
        }

        .cards-container {
          grid-template-columns: 1fr;
        }
      }
    </style>
  </head>
  <body>
    <!-- Sidebar -->
    <aside class="side-menu">
      <nav>
        <ul>
          <li><a href="/"><i class="fas fa-tachometer-alt"></i> Dashboard</a></li>
          <li><a href="/sessions/scan"><i class="fas fa-qrcode"></i> Scan QR</a></li>
          <li><a href="/login"><i class="fas fa-sign-in-alt"></i> Login</a></li>
          <li><a href="/sessions/create"><i class="fas fa-plus-circle"></i> Create Session</a></li>
          <li><a href="/sessions/all"><i class="fas fa-list"></i> All Sessions</a></li>
          <li><a href="/cashlogs/create"><i class="fas fa-money-bill-wave"></i> Create Cash Log</a></li>
          <li><a href="/cashlogs/all"><i class="fas fa-file-alt"></i> All Cash Logs</a></li>
          <li><a href="/tournament"><i class="fas fa-trophy"></i> Tournaments</a></li>
          <li><a href="/tournament/match/form" class="active"><i class="fas fa-gamepad"></i> Match Form</a></li>
          <li><a href="/tournament/admin"><i class="fas fa-user-shield"></i> Admin Panel</a></li>
        </ul>
      </nav>
    </aside>

    <!-- Main Content -->
    <div class="main-content">
      <div class="container mt-4">
      <div class="row justify-content-center">
        <div class="col-lg-10">
          <!-- Header -->
          <div class="header-container">
            <!-- Header content is now the background image -->
          </div>

          <!-- Alert Messages -->
          <div id="alertContainer"></div>

          <!-- STEP 1: Email Input & Load -->
          <div class="step-container" id="step1">
            <div class="step-header">
              <h5 class="mb-0">Step 1: Enter Player Emails</h5>
            </div>
            <div class="step-body">
              <div class="row">
                <div class="col-md-6">
                  <div class="mb-3">
                    <label class="form-label">Player 1*</label>
                    <input
                      type="email"
                      id="P1_email"
                      name="P1_email"
                      class="form-control"
                      placeholder="player1@example.com"
                      required
                    />
                  </div>
                </div>

                <div class="col-md-6">
                  <div class="mb-3">
                    <label class="form-label">Player 2*</label>
                    <input
                      type="email"
                      id="P2_email"
                      name="P2_email"
                      class="form-control"
                      placeholder="player2@example.com"
                      required
                    />
                  </div>
                </div>
              </div>

              <div class="text-center mt-3">
                <button
                  type="button"
                  id="loadBothBtn"
                  class="btn load-btn px-5"
                  onclick="loadBothStats()"
                >
                  <span id="loadText">
                    <i class="fas fa-sync-alt me-2"></i> Load Player Data
                  </span>
                  <span
                    id="loadSpinner"
                    class="spinner-border spinner-border-sm ms-2"
                    style="display: none"
                  ></span>
                </button>
              </div>
            </div>
          </div>

          <!-- STEP 2: Player Data & Cards (hidden until loaded) -->
          <div class="step-container" id="step2" style="display: none">
            <div class="step-header">
              <h5 class="mb-0">Step 2: Select Player Cards</h5>
            </div>
            <div class="step-body">
              <div class="row">
                <!-- Player 1 Card Section -->
                <div class="col-md-5">
                  <div class="player-card">
                    <h6 id="p1NameHeading">Player 1 Details</h6>

                    <!-- Rating Display -->
                    <div class="rating-display">
                      <div class="rating-value" id="p1RatingDisplay">1000</div>
                      <div class="rating-label">Rating</div>
                    </div>

                    <!-- Hidden inputs for form submission -->
                    <input type="hidden" id="p1" name="p1" />
                    <input
                      type="hidden"
                      id="P1_Curr"
                      name="P1_Curr"
                      value="1000"
                    />

                    <!-- Stats -->
                    <div class="stats-card">
                      <div class="stats-label">
                        <i class="fas fa-chart-bar me-2"></i>Match Statistics
                      </div>
                      <div id="p1StatsContent">
                        <div class="stats-grid">
                          <div class="stat-box">
                            <div class="stat-value">0W-0L</div>
                            <div class="stat-label">Record</div>
                          </div>
                          <div class="stat-box">
                            <div class="stat-value">0</div>
                            <div class="stat-label">GS</div>
                          </div>
                          <div class="stat-box">
                            <div class="stat-value">0</div>
                            <div class="stat-label">GC</div>
                          </div>
                          <div class="stat-box">
                            <div class="stat-value">0%</div>
                            <div class="stat-label">Win Rate</div>
                          </div>
                        </div>
                      </div>
                    </div>

                    <!-- Available Cards -->
                    <div class="mb-3">
                      <div class="stats-label">
                        <i class="fas fa-cards-blank me-2"></i>Available Cards
                      </div>
                      <div id="p1CardsContainer" class="cards-container">
                        <p
                          class="text-center py-3"
                          style="color: rgba(255, 255, 255, 0.6)"
                        >
                          <i class="fas fa-spinner fa-spin me-2"></i>
                          Loading cards...
                        </p>
                      </div>
                    </div>

                    <!-- Selected Card Info -->
                    <!-- Commented out as requested -->
                    <!--
                    <div
                      id="p1SelectedCard"
                      class="selected-card-info"
                      style="display: none"
                    >
                      <small style="color: white;">
                        <strong>Selected Card:</strong>
                        <span id="p1SelectedCardText"></span>
                      </small>
                    </div>
                    -->
                  </div>
                </div>

                <div
                  class="col-md-2 d-flex align-items-center justify-content-center"
                >
                  <div class="vs-divider">VS</div>
                </div>

                <!-- Player 2 Card Section -->
                <div class="col-md-5">
                  <div class="player-card">
                    <h6 id="p2NameHeading">Player 2 Details</h6>

                    <!-- Rating Display -->
                    <div class="rating-display">
                      <div class="rating-value" id="p2RatingDisplay">1000</div>
                      <div class="rating-label">Rating</div>
                    </div>

                    <!-- Hidden inputs for form submission -->
                    <input type="hidden" id="p2" name="p2" />
                    <input
                      type="hidden"
                      id="P2_Curr"
                      name="P2_Curr"
                      value="1000"
                    />

                    <!-- Stats -->
                    <div class="stats-card">
                      <div class="stats-label">
                        <i class="fas fa-chart-bar me-2"></i>Match Statistics
                      </div>
                      <div id="p2StatsContent">
                        <div class="stats-grid">
                          <div class="stat-box">
                            <div class="stat-value">0W-0L</div>
                            <div class="stat-label">Record</div>
                          </div>
                          <div class="stat-box">
                            <div class="stat-value">0</div>
                            <div class="stat-label">GS</div>
                          </div>
                          <div class="stat-box">
                            <div class="stat-value">0</div>
                            <div class="stat-label">GC</div>
                          </div>
                          <div class="stat-box">
                            <div class="stat-value">0%</div>
                            <div class="stat-label">Win Rate</div>
                          </div>
                        </div>
                      </div>
                    </div>

                    <!-- Available Cards -->
                    <div class="mb-3">
                      <div class="stats-label">
                        <i class="fas fa-cards-blank me-2"></i>Available Cards
                      </div>
                      <div id="p2CardsContainer" class="cards-container">
                        <p
                          class="text-center py-3"
                          style="color: rgba(255, 255, 255, 0.6)"
                        >
                          <i class="fas fa-spinner fa-spin me-2"></i>
                          Loading cards...
                        </p>
                      </div>
                    </div>

                    <!-- Selected Card Info -->
                    <!-- Commented out as requested -->
                    <!--
                    <div
                      id="p2SelectedCard"
                      class="selected-card-info"
                      style="display: none"
                    >
                      <small style="color: white;">
                        <strong>Selected Card:</strong>
                        <span id="p2SelectedCardText"></span>
                      </small>
                    </div>
                    -->
                  </div>
                </div>
              </div>

              <!-- No Cards Alert -->
              <div
                id="noCardsAlert"
                class="alert alert-danger mt-3"
                style="display: none"
              >
                <div class="mb-3">
                  <i class="fas fa-exclamation-triangle me-2"></i>
                  <strong
                    >One or both players have no valid cards available!</strong
                  >
                  Cannot proceed with match.
                </div>
                <div class="text-center">
                  <button class="btn btn-primary" onclick="resetMatchForm()">
                    <i class="fas fa-plus-circle me-2"></i> Process Another Match
                  </button>
                </div>
              </div>

              <!-- Proceed to Next Step Alert -->
              <div
                id="proceedAlert"
                class="alert alert-success mt-3"
                style="display: none"
              >
                <i class="fas fa-check-circle me-2"></i>
                <strong>Both players have cards selected!</strong> Proceed to
                enter match details.
              </div>
            </div>
          </div>

          <!-- STEP 3: Match Score Input (hidden until cards selected) -->
          <div class="step-container" id="step3" style="display: none">
            <div class="step-header">
              <h5 class="mb-0">Step 3: Enter Match Results</h5>
            </div>
            <div class="step-body">
              <div class="row">
                <div class="col-md-5">
                  <div class="mb-3">
                    <label class="form-label">Goals Scored *</label>
                    <input
                      type="number"
                      id="P1_GS"
                      name="P1_GS"
                      class="form-control"
                      min="0"
                      max="50"
                      value="0"
                      placeholder="0"
                      required
                    />
                  </div>

                  <!-- Penalty for Player 1 (hidden by default) -->
                  <div class="mb-3" id="p1PenaltyDiv" style="display: none">
                    <label class="form-label">Penalties (Tiebreaker) *</label>
                    <input
                      type="number"
                      id="P1_penalty"
                      name="P1_penalty"
                      class="form-control"
                      min="0"
                      max="50"
                      value="0"
                    />
                    <small class="form-text text-muted"
                      >Required if both players score equal goals</small
                    >
                  </div>
                </div>

                <div
                  class="col-md-2 d-flex align-items-end justify-content-center"
                >
                  <div class="vs-divider mb-3" style="margin-top: 1.5rem">
                    VS
                  </div>
                </div>

                <div class="col-md-5">
                  <div class="mb-3">
                    <label class="form-label">Goals Scored *</label>
                    <input
                      type="number"
                      id="P2_GS"
                      name="P2_GS"
                      class="form-control"
                      min="0"
                      max="50"
                      value="0"
                      placeholder="0"
                      required
                    />
                  </div>

                  <!-- Penalty for Player 2 (hidden by default) -->
                  <div class="mb-3" id="p2PenaltyDiv" style="display: none">
                    <label class="form-label">Penalties (Tiebreaker) *</label>
                    <input
                      type="number"
                      id="P2_penalty"
                      name="P2_penalty"
                      class="form-control"
                      min="0"
                      max="50"
                      value="0"
                    />
                    <small class="form-text text-muted"
                      >Required if both players score equal goals</small
                    >
                  </div>
                </div>
              </div>

              <!-- Hidden inputs for rating parameters (default values) -->
              <input type="hidden" id="lambda" name="lambda" value="12" />
              <input type="hidden" id="W" name="W" value="1.0" />
              <input type="hidden" id="alpha" name="alpha" value="0.1" />

              <!-- Validation Summary -->
              <div
                id="validationSummary"
                class="alert alert-warning mt-3"
                style="display: none"
              >
                <h6>Please fix the following issues:</h6>
                <ul id="validationList"></ul>
              </div>

              <!-- Submit Button -->
              <div class="text-center mt-4">
                <button
                  type="button"
                  id="submitBtn"
                  class="btn btn-primary btn-lg px-5"
                  onclick="submitMatchForm()"
                  disabled
                >
                  <span id="submitText">Process Match</span>
                  <span
                    id="loadingSpinner"
                    class="spinner-border spinner-border-sm ms-2"
                    style="display: none"
                  ></span>
                </button>
              </div>
            </div>
          </div>

          <!-- Result Container -->
          <div id="resultContainer" style="display: none"></div>
        </div>
      </div>
      </div>
    </div>

    <script>
      const API_BASE_URL =
        window.location.hostname === "localhost"
          ? "http://localhost:5000/match"
          : "https://api.consolegaming.in/match";
      let loadedPlayerData = { p1: null, p2: null };
      let selectedP1Card = null;
      let selectedP2Card = null;

      // ==================== INITIALIZATION ====================
      window.addEventListener("load", async function () {
        // Set default hidden values
        document.getElementById("lambda").value = "12";
        document.getElementById("W").value = "1.0";
        document.getElementById("alpha").value = "0.1";

        // Add event listeners for GS inputs to toggle penalties
        document
          .getElementById("P1_GS")
          .addEventListener("input", checkIfPenaltiesNeeded);
        document
          .getElementById("P2_GS")
          .addEventListener("input", checkIfPenaltiesNeeded);
      });

      // ==================== STEP 1: LOAD BOTH STATS & CARDS ====================
      async function loadBothStats() {
        const p1Email = document
          .getElementById("P1_email")
          .value.trim()
          .toLowerCase();
        const p2Email = document
          .getElementById("P2_email")
          .value.trim()
          .toLowerCase();

        if (!p1Email || !p2Email) {
          showAlert(
            "warning",
            '<i class="fas fa-exclamation-triangle me-2"></i> Enter both emails first.'
          );
          return;
        }

        if (!isValidEmail(p1Email) || !isValidEmail(p2Email)) {
          showAlert(
            "warning",
            '<i class="fas fa-exclamation-triangle me-2"></i> Enter valid email addresses.'
          );
          return;
        }

        const btn = document.getElementById("loadBothBtn");
        const loadText = document.getElementById("loadText");
        const loadSpinner = document.getElementById("loadSpinner");

        loadText.style.display = "none";
        loadSpinner.style.display = "inline-block";
        btn.disabled = true;

        try {
          console.log("üîÑ Step 1: Loading user data...");

          // ‚úÖ STEP 1: Load both user data FIRST and WAIT for completion
          await Promise.all([
            loadUserData(p1Email, "p1"),
            loadUserData(p2Email, "p2"),
          ]);

          console.log(
            "‚úÖ User data loaded. loadedPlayerData:",
            loadedPlayerData
          );

          // ‚úÖ STEP 2: ONLY AFTER user data is loaded, fetch cards
          console.log("üîÑ Step 2: Loading cards...");
          await Promise.all([
            loadUserCards(p1Email, "p1"),
            loadUserCards(p2Email, "p2"),
          ]);

          // Hide Step 1 and show Step 2
          document.getElementById("step1").style.display = "none";
          document.getElementById("step2").style.display = "block";

          showAlert(
            "success",
            '<i class="fas fa-users me-2"></i> Loaded player data and cards successfully!'
          );
        } catch (error) {
          console.error("‚ùå Error loading data:", error);
          showAlert(
            "danger",
            '<i class="fas fa-exclamation-circle me-2"></i> Error loading data: ' +
              error.message
          );
        } finally {
          loadText.style.display = "inline";
          loadSpinner.style.display = "none";
          btn.disabled = false;
        }
      }

      // Find and replace the loadUserData function's stats display section with this:

      async function loadUserData(email, player) {
        try {
          console.log(
            `üì• [${player.toUpperCase()}] Loading user data for ${email}...`
          );

          const response = await axios.get(`${API_BASE_URL}/user/${email}`, {
            timeout: 10000,
          });

          if (response.data.success) {
            const data = response.data.data;

            console.log(`‚úÖ [${player.toUpperCase()}] API Response:`, data);

            // Set player name in hidden input and display
            const playerName = data.name || "Unknown Player";
            document.getElementById(player).value = playerName;
            document.getElementById(
              player === "p1" ? "p1NameHeading" : "p2NameHeading"
            ).textContent = `${playerName}'s Details`;

            // Set rating in hidden input and display
            const rating = data.rating.toFixed(2);
            document.getElementById(
              player === "p1" ? "P1_Curr" : "P2_Curr"
            ).value = rating;
            document.getElementById(
              player === "p1" ? "p1RatingDisplay" : "p2RatingDisplay"
            ).textContent = rating;

            // ‚úÖ UPDATED: Set stats display with CITY instead of TEAM
            const statsContent = `
        <div class="stats-grid">
          <div class="stat-box">
            <div class="stat-value">${data.record}</div>
            <div class="stat-label">Record</div>
          </div>
          <div class="stat-box">
            <div class="stat-value">${data.gs}</div>
            <div class="stat-label">GS</div>
          </div>
          <div class="stat-box">
            <div class="stat-value">${data.gc}</div>
            <div class="stat-label">GC</div>
          </div>
          <div class="stat-box">
            <div class="stat-value">${data.winPercentage}%</div>
            <div class="stat-label">Win Rate</div>
          </div>
          <div class="stat-box">
            <div class="stat-value">${data.city}</div>
            <div class="stat-label">City</div>
          </div>
        </div>
      `;
            document.getElementById(
              player === "p1" ? "p1StatsContent" : "p2StatsContent"
            ).innerHTML = statsContent;

            // ‚úÖ STORE UserID properly in loadedPlayerData
            loadedPlayerData[player] = {
              email: email,
              userID: data.userID, // ‚úÖ Store the UserID
              ...data,
            };

            console.log(`‚úÖ Stored ${player} data with UserID:`, data.userID);
            console.log(`   Current loadedPlayerData:`, loadedPlayerData);

            return true; // ‚úÖ Return to indicate completion
          } else {
            throw new Error(response.data.message || "User not found");
          }
        } catch (error) {
          console.error(`‚ùå Error loading ${player} data:`, error.message);
          throw error;
        }
      }

      // ==================== LOAD USER CARDS ====================
      async function loadUserCards(email, player) {
        const container = document.getElementById(`${player}CardsContainer`);

        try {
          // ‚úÖ Get UserID from loadedPlayerData
          const userID = loadedPlayerData[player]?.userID;

          console.log(
            `üì• [${player.toUpperCase()}] Attempting to load cards...`
          );
          console.log(`   UserID from loadedPlayerData:`, userID);

          if (!userID) {
            console.error(`‚ùå [${player.toUpperCase()}] No UserID found!`);
            container.innerHTML = `
              <div class="alert alert-danger text-center">
                <i class="fas fa-exclamation-circle me-2"></i> Error: User ID not loaded
              </div>
            `;
            // Let checkBothCardsSelected handle the alert display
            checkBothCardsSelected();
            return;
          }

          console.log(
            `üîç [${player.toUpperCase()}] Fetching cards with UserID: ${userID}`
          );

          // ‚úÖ Use UserID endpoint
          const response = await axios.get(
            `${API_BASE_URL}/cards/userid/${userID}`,
            { timeout: 10000 }
          );

          console.log(
            `‚úÖ [${player.toUpperCase()}] Cards response:`,
            response.data
          );

          if (!response.data.success) {
            container.innerHTML = `
              <div class="alert alert-danger text-center">
                <i class="fas fa-exclamation-circle me-2"></i> ${response.data.message}
              </div>
            `;
            // Let checkBothCardsSelected handle the alert display
            checkBothCardsSelected();
            return;
          }

          if (!response.data.hasCards || response.data.cards.length === 0) {
            container.innerHTML = `
              <div class="alert alert-warning text-center">
                <i class="fas fa-inbox me-2"></i> No valid cards available
              </div>
            `;
            // Let checkBothCardsSelected handle the alert display
            checkBothCardsSelected();
            return;
          }

          container.innerHTML = "";
          const cards = response.data.cards;

          cards.forEach((card, index) => {
            const cardDiv = document.createElement("div");
            cardDiv.className = "card-selectable";

            // ‚úÖ Determine color based on days remaining
            const daysClass =
              card.daysRemaining <= 5
                ? "days-danger"
                : card.daysRemaining <= 10
                ? "days-warning"
                : "days-success";

            // ‚úÖ Format expiry date
            const expiryDate = new Date(card.expiryDate).toLocaleDateString(
              "en-IN",
              {
                day: "2-digit",
                month: "short",
                year: "numeric",
              }
            );

            // ‚úÖ Updated HTML with CardCode, Title, and ExpiryDate
            cardDiv.innerHTML = `
              <div class="custom-checkbox">
                <i class="fas fa-check"></i>
              </div>
              <div class="card-title">
                <i class="fas fa-ticket-alt me-2"></i> ${card.title}
              </div>
              <div class="card-code">${card.cardCode}</div>
              <div class="card-expiry">
                <i class="fas fa-calendar-alt me-1"></i>
                <strong>Expires:</strong> ${expiryDate}
              </div>
              <div class="card-days">
                <span class="days-badge ${daysClass}">
                  <i class="fas fa-hourglass-end me-1"></i>
                  ${card.daysRemaining} days
                </span>
              </div>
            `;

            cardDiv.addEventListener("click", () => {
              selectCard(player, card, cardDiv);
            });

            container.appendChild(cardDiv);

            // Auto-select first card
            if (index === 0) {
              cardDiv.click();
            }
          });

          console.log(
            `‚úÖ [${player.toUpperCase()}] Loaded ${cards.length} card(s)`
          );

          // Check the overall card selection state after loading
          checkBothCardsSelected();
        } catch (error) {
          console.error(
            `‚ùå [${player.toUpperCase()}] Error loading cards:`,
            error.message
          );
          container.innerHTML = `
            <div class="alert alert-danger text-center">
              <i class="fas fa-exclamation-circle me-2"></i> Error loading cards: ${error.message}
            </div>
          `;
          // Let checkBothCardsSelected handle the alert display
          checkBothCardsSelected();
        }
      }

      // ==================== SELECT CARD ====================
      function selectCard(player, card, cardDiv) {
        // Check if already selected - allow deselection
        const isAlreadySelected = cardDiv.classList.contains("selected");

        if (isAlreadySelected) {
          // Deselect the card
          cardDiv.classList.remove("selected");
          cardDiv.querySelector(".custom-checkbox i").style.opacity = "0";

          // Clear stored card
          if (player === "p1") {
            selectedP1Card = null;
          } else {
            selectedP2Card = null;
          }
        } else {
          // Remove previous selection
          document
            .querySelectorAll(`#${player}CardsContainer .card-selectable`)
            .forEach((c) => {
              c.classList.remove("selected");
              c.querySelector(".custom-checkbox i").style.opacity = "0";
            });

          // Mark as selected
          cardDiv.classList.add("selected");
          cardDiv.querySelector(".custom-checkbox i").style.opacity = "1";

          // Store selected card
          if (player === "p1") {
            selectedP1Card = card.cardID;
          } else {
            selectedP2Card = card.cardID;
          }
        }

        console.log(`Selected ${player} card:`, card.cardID);

        // Check if both cards are selected
        checkBothCardsSelected();
      }

      // ==================== CHECK BOTH CARDS SELECTED ====================
      function checkBothCardsSelected() {
        const bothSelected = selectedP1Card && selectedP2Card;
        const submitBtn = document.getElementById("submitBtn");
        const noCardsAlert = document.getElementById("noCardsAlert");
        const proceedAlert = document.getElementById("proceedAlert");

        // Check if either player has no cards available
        const p1HasCards = document.getElementById("p1CardsContainer").querySelector(".card-selectable") !== null;
        const p2HasCards = document.getElementById("p2CardsContainer").querySelector(".card-selectable") !== null;
        const hasNoCards = !p1HasCards || !p2HasCards;

        if (hasNoCards) {
          // One or both players have no cards available
          submitBtn.disabled = true;
          if (noCardsAlert) noCardsAlert.style.display = "block";
          if (proceedAlert) proceedAlert.style.display = "none";
          document.getElementById("step3").style.display = "none";
        } else if (bothSelected) {
          // Both players have cards and both are selected
          submitBtn.disabled = false;
          if (noCardsAlert) noCardsAlert.style.display = "none";
          if (proceedAlert) proceedAlert.style.display = "block";
          document.getElementById("step3").style.display = "block";
        } else {
          // Both players have cards but not both are selected
          submitBtn.disabled = true;
          if (noCardsAlert) noCardsAlert.style.display = "none";
          if (proceedAlert) proceedAlert.style.display = "none";
          document.getElementById("step3").style.display = "none";
        }
      }

      // ==================== CHECK PENALTIES ====================
      function checkIfPenaltiesNeeded() {
        const p1GS = parseInt(document.getElementById("P1_GS").value) || 0;
        const p2GS = parseInt(document.getElementById("P2_GS").value) || 0;
        const showPenalties = p1GS === p2GS;

        document.getElementById("p1PenaltyDiv").style.display = showPenalties
          ? "block"
          : "none";
        document.getElementById("p2PenaltyDiv").style.display = showPenalties
          ? "block"
          : "none";
      }

      // ==================== FORM VALIDATION ====================
      function validateForm() {
        const errors = [];
        const validationSummary = document.getElementById("validationSummary");
        const validationList = document.getElementById("validationList");

        const requiredFields = [
          { id: "p1", name: "Player 1 Name", minLength: 2 },
          { id: "p2", name: "Player 2 Name", minLength: 2 },
          { id: "P1_email", name: "Player 1 Email", type: "email" },
          { id: "P2_email", name: "Player 2 Email", type: "email" },
        ];

        const requiredNumbers = [
          { id: "P1_GS", name: "Player 1 Goals", min: 0, max: 50 },
          { id: "P2_GS", name: "Player 2 Goals", min: 0, max: 50 },
        ];

        // Add penalties if displayed
        if (document.getElementById("p1PenaltyDiv").style.display !== "none") {
          requiredNumbers.push({
            id: "P1_penalty",
            name: "Player 1 Penalties",
            min: 0,
            max: 50,
          });
          requiredNumbers.push({
            id: "P2_penalty",
            name: "Player 2 Penalties",
            min: 0,
            max: 50,
          });
        }

        // Check cards selected
        if (!selectedP1Card || !selectedP2Card) {
          errors.push("Both players must have cards selected");
        }

        // Validate text fields
        requiredFields.forEach((field) => {
          const element = document.getElementById(field.id);
          const value = element.value.trim();

          if (!value) {
            errors.push(`${field.name} is required`);
          } else if (field.minLength && value.length < field.minLength) {
            errors.push(
              `${field.name} must be at least ${field.minLength} characters`
            );
          } else if (field.type === "email" && !isValidEmail(value)) {
            errors.push(`${field.name} must be valid`);
          }
        });

        // Validate number fields
        requiredNumbers.forEach((field) => {
          const element = document.getElementById(field.id);
          const value = parseFloat(element.value);

          if (isNaN(value) || value < field.min || value > field.max) {
            errors.push(
              `${field.name} must be between ${field.min} and ${field.max}`
            );
          }
        });

        // Different players check
        const p1Name = document.getElementById("p1").value.trim().toLowerCase();
        const p2Name = document.getElementById("p2").value.trim().toLowerCase();
        if (p1Name && p2Name && p1Name === p2Name) {
          errors.push("Player names must be different");
        }

        if (errors.length > 0) {
          validationList.innerHTML = errors
            .map((error) => `<li>${error}</li>`)
            .join("");
          validationSummary.style.display = "block";
          return false;
        } else {
          validationSummary.style.display = "none";
          return true;
        }
      }

      // ==================== FORM SUBMISSION ====================
      async function submitMatchForm() {
        if (!validateForm()) {
          return;
        }

        const submitBtn = document.getElementById("submitBtn");
        const submitText = document.getElementById("submitText");
        const loadingSpinner = document.getElementById("loadingSpinner");

        try {
          submitBtn.disabled = true;
          submitText.textContent = "Processing...";
          loadingSpinner.style.display = "inline-block";

          const formData = {
            p1: document.getElementById("p1").value.trim(),
            p2: document.getElementById("p2").value.trim(),
            P1_email: document
              .getElementById("P1_email")
              .value.trim()
              .toLowerCase(),
            P2_email: document
              .getElementById("P2_email")
              .value.trim()
              .toLowerCase(),
            P1_GS: parseInt(document.getElementById("P1_GS").value) || 0,
            P2_GS: parseInt(document.getElementById("P2_GS").value) || 0,
            P1_penalty:
              parseInt(document.getElementById("P1_penalty").value) || 0,
            P2_penalty:
              parseInt(document.getElementById("P2_penalty").value) || 0,
            P1_cardID: selectedP1Card,
            P2_cardID: selectedP2Card,
            lambda: parseFloat(document.getElementById("lambda").value) || 12,
            W: parseFloat(document.getElementById("W").value) || 1.0,
            alpha: parseFloat(document.getElementById("alpha").value) || 0.1,
          };

          console.log("Sending match data:", formData);

          const response = await axios.post(
            `${API_BASE_URL}/process`,
            formData,
            {
              headers: { "Content-Type": "application/json" },
              timeout: 30000,
            }
          );

          if (response.data.success) {
            showAlert(
              "success",
              "<i class='fas fa-trophy me-2'></i> Match processed! Cards marked as used."
            );
            displayResult(response.data.data, formData);
          } else {
            showAlert("danger", response.data.message);
          }
        } catch (error) {
          console.error("Error:", error);
          let errorMessage = "Failed to process match. ";
          if (error.response?.data?.message) {
            errorMessage += error.response.data.message;
          } else if (error.message) {
            errorMessage += error.message;
          }
          showAlert(
            "danger",
            `<i class="fas fa-exclamation-circle me-2"></i> ${errorMessage}`
          );
        } finally {
          submitBtn.disabled = false;
          submitText.textContent = "Process Match";
          loadingSpinner.style.display = "none";
        }
      }

      // ==================== HELPER FUNCTIONS ====================
      function isValidEmail(email) {
        const emailRegex = /^[^\s@]+@[^\s@]+\.[^\s@]+$/;
        return emailRegex.test(email);
      }

      function showAlert(type, message) {
        const alertHTML = `
          <div class="alert alert-${type} alert-dismissible fade show" role="alert">
            ${message}
            <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
          </div>
        `;
        document.getElementById("alertContainer").innerHTML = alertHTML;
      }

      function displayResult(result, originalData) {
        const safeValue = (value, defaultValue = 0) => value ?? defaultValue;

        // In the displayResult function, update the safeResult object:

        const safeResult = {
          player1: result.player1 || originalData.p1 || "Player 1",
          player2: result.player2 || originalData.p2 || "Player 2",
          player1Email: result.player1Email || originalData.P1_email || "",
          player2Email: result.player2Email || originalData.P2_email || "",
          winner: result.winner || "Unknown",
          player1CurrentRating: safeValue(result.player1CurrentRating, 1000),
          player2CurrentRating: safeValue(result.player2CurrentRating, 1000),
          player1NewRating: safeValue(result.player1NewRating, 1000),
          player2NewRating: safeValue(result.player2NewRating, 1000),
          player1RatingChange: safeValue(result.player1RatingChange, 0),
          player2RatingChange: safeValue(result.player2RatingChange, 0),
          player1ExpectedScore: safeValue(result.player1ExpectedScore, 0.5),
          player2ExpectedScore: safeValue(result.player2ExpectedScore, 0.5),
          goalMargin: safeValue(result.goalMargin, 0),
          p1UpdatedStats: result.p1UpdatedStats || {
            gs: 0,
            gc: 0,
            mp: 0,
            mw: 0,
            winPercentage: "0.00",
            city: "Unknown", // ‚úÖ Changed from team to city
            record: "0W-0L",
          },
          p2UpdatedStats: result.p2UpdatedStats || {
            gs: 0,
            gc: 0,
            mp: 0,
            mw: 0,
            winPercentage: "0.00",
            city: "Unknown", // ‚úÖ Changed from team to city
            record: "0W-0L",
          },
          isPenalty: result.isPenalty || false,
          p1Penalty: safeValue(result.p1Penalty, 0),
          p2Penalty: safeValue(result.p2Penalty, 0),
        };

        let scoreLine = `${originalData.P1_GS}-${originalData.P2_GS}`;
        if (safeResult.isPenalty) {
          scoreLine += ` (${safeResult.p1Penalty}-${safeResult.p2Penalty} pens)`;
        }

        const resultHTML = `
          <div class="card mt-4 match-result-card fade-in">
            <div class="card-header">
              <h5 class="mb-0"><i class="fas fa-trophy me-2"></i> Match Result</h5>
            </div>
            <div class="card-body">
              <!-- Match Summary -->
              <div class="match-summary">
                <h4>${safeResult.player1} vs ${safeResult.player2}</h4>
                <h3 class="pulse">${scoreLine}</h3>
                <h5>üèÜ Winner: ${safeResult.winner}</h5>
              </div>
              
              <!-- Rating Changes -->
              <div class="row mt-4">
                <div class="col-md-6">
                  <div class="player-result-card">
                    <div class="card-header">
                      <h6 class="mb-0">${safeResult.player1}</h6>
                      <small>${safeResult.player1Email}</small>
                    </div>
                    <div class="card-body text-center">
                      <div class="row">
                        <div class="col-6">
                          <small class="text-muted">Previous Rating</small>
                          <h5>${safeResult.player1CurrentRating.toFixed(2)}</h5>
                        </div>
                        <div class="col-6">
                          <small class="text-muted">New Rating</small>
                          <h5 class="rating-change-${
                            safeResult.player1RatingChange >= 0
                              ? "positive"
                              : "negative"
                          }">
                            ${safeResult.player1NewRating.toFixed(2)}
                          </h5>
                        </div>
                      </div>
                      <div class="mt-3">
                        <span class="badge bg-${
                          safeResult.player1RatingChange >= 0
                            ? "success"
                            : "danger"
                        }">
                          ${
                            safeResult.player1RatingChange >= 0 ? "+" : ""
                          }${safeResult.player1RatingChange.toFixed(2)}
                        </span>
                      </div>
                    </div>
                  </div>
                  <!-- Updated Stats for Player 1 -->
                  <div class="player-result-card mt-3">
                    <div class="card-header">
                      <small>Updated Stats</small>
                    </div>
                    <div class="card-body small">
                      ${safeResult.p1UpdatedStats.record} | ${
          safeResult.p1UpdatedStats.gs
        } GS (+${originalData.P1_GS}) / ${safeResult.p1UpdatedStats.gc} GC (+${
          originalData.P2_GS
        }) | ${safeResult.p1UpdatedStats.winPercentage}% Win
                    </div>
                  </div>
                </div>
                
                <div class="col-md-6">
                  <div class="player-result-card">
                    <div class="card-header">
                      <h6 class="mb-0">${safeResult.player2}</h6>
                      <small>${safeResult.player2Email}</small>
                    </div>
                    <div class="card-body text-center">
                      <div class="row">
                        <div class="col-6">
                          <small class="text-muted">Previous Rating</small>
                          <h5>${safeResult.player2CurrentRating.toFixed(2)}</h5>
                        </div>
                        <div class="col-6">
                          <small class="text-muted">New Rating</small>
                          <h5 class="rating-change-${
                            safeResult.player2RatingChange >= 0
                              ? "positive"
                              : "negative"
                          }">
                            ${safeResult.player2NewRating.toFixed(2)}
                          </h5>
                        </div>
                      </div>
                      <div class="mt-3">
                        <span class="badge bg-${
                          safeResult.player2RatingChange >= 0
                            ? "success"
                            : "danger"
                        }">
                          ${
                            safeResult.player2RatingChange >= 0 ? "+" : ""
                          }${safeResult.player2RatingChange.toFixed(2)}
                        </span>
                      </div>
                    </div>
                  </div>
                  <!-- Updated Stats for Player 2 -->
                  <div class="player-result-card mt-3">
                    <div class="card-header">
                      <small>Updated Stats</small>
                    </div>
                    <div class="card-body small">
                      ${safeResult.p2UpdatedStats.record} | ${
          safeResult.p2UpdatedStats.gs
        } GS (+${originalData.P2_GS}) / ${safeResult.p2UpdatedStats.gc} GC (+${
          originalData.P1_GS
        }) | ${safeResult.p2UpdatedStats.winPercentage}% Win
                    </div>
                  </div>
                </div>
              </div>
              
              <!-- Action Buttons -->
              <div class="text-center mt-4">
                <button class="btn btn-primary me-2" onclick="resetMatchForm()">
                  <i class="fas fa-plus-circle me-2"></i> Process Another Match
                </button>
                <button class="btn btn-outline-secondary" onclick="downloadResult()">
                  <i class="fas fa-download me-2"></i> Download Result
                </button>
              </div>
            </div>
          </div>
        `;

        const resultContainer = document.getElementById("resultContainer");
        resultContainer.innerHTML = resultHTML;
        resultContainer.style.display = "block";

        setTimeout(() => {
          resultContainer.scrollIntoView({ behavior: "smooth" });
        }, 100);

        window.lastResult = safeResult;
      }

      function resetMatchForm() {
        // Reset form
        document.getElementById("P1_email").value = "";
        document.getElementById("P2_email").value = "";
        document.getElementById("P1_GS").value = "0";
        document.getElementById("P2_GS").value = "0";
        document.getElementById("P1_penalty").value = "0";
        document.getElementById("P2_penalty").value = "0";
        document.getElementById("p1PenaltyDiv").style.display = "none";
        document.getElementById("p2PenaltyDiv").style.display = "none";

        // Reset selections
        selectedP1Card = null;
        selectedP2Card = null;

        // Show Step 1, hide others
        document.getElementById("step1").style.display = "block";
        document.getElementById("step2").style.display = "none";
        document.getElementById("step3").style.display = "none";
        document.getElementById("resultContainer").style.display = "none";
        document.getElementById("validationSummary").style.display = "none";

        // Reset buttons
        document.getElementById("loadBothBtn").disabled = false;
        document.getElementById("submitBtn").disabled = true;

        window.scrollTo({ top: 0, behavior: "smooth" });
      }

      function downloadResult() {
        if (window.lastResult) {
          const dataStr =
            "data:text/json;charset=utf-8," +
            encodeURIComponent(JSON.stringify(window.lastResult, null, 2));
          const downloadAnchorNode = document.createElement("a");
          downloadAnchorNode.setAttribute("href", dataStr);
          downloadAnchorNode.setAttribute(
            "download",
            `fifa_match_${Date.now()}.json`
          );
          document.body.appendChild(downloadAnchorNode);
          downloadAnchorNode.click();
          downloadAnchorNode.remove();
        }
      }
    </script>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>
  </body>
</html>
