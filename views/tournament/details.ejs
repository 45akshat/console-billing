<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="UTF-8">
  <title>
    <%= tournament.tournament_name %> - Registered Users
  </title>
  <style>
    body {
      font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
      background: #f4f6f8;
      margin: 0;
      padding: 0;
      color: #333;
    }

    .poster {
      background: #000;
      text-align: center;
    }

    .poster img {
      max-height: 280px;
      width: auto;
      max-width: 100%;
      object-fit: cover;
      border-bottom: 3px solid #ccc;
    }

    .content {
      max-width: 1200px;
      margin: 30px auto;
      background: #fff;
      padding: 25px;
      border-radius: 10px;
      box-shadow: 0 2px 8px rgba(0, 0, 0, 0.08);
    }

    h2 {
      text-align: center;
      margin-bottom: 20px;
      text-transform: uppercase;
      font-weight: 600;
      color: #222;
    }

    .search-container {
      text-align: right;
      margin-bottom: 10px;
    }

    .search-container input {
      padding: 6px 10px;
      width: 250px;
      border: 1px solid #ccc;
      border-radius: 6px;
      font-size: 14px;
    }

    .table-container {
      overflow-x: auto;
    }

    table {
      width: 100%;
      border-collapse: collapse;
      border: 1px solid #ddd;
      min-width: 1000px;
    }

    th,
    td {
      border: 1px solid #ddd;
      padding: 8px 10px;
      text-align: center;
      font-size: 13px;
      vertical-align: middle;
      white-space: nowrap;
    }

    th {
      background-color: #f0f2f5;
      font-weight: 600;
    }

    td form {
      display: flex;
      flex-direction: column;
      gap: 5px;
      align-items: center;
    }

    input[type="text"],
    select {
      padding: 4px 6px;
      border: 1px solid #ccc;
      border-radius: 4px;
      font-size: 12px;
      width: 100%;
      box-sizing: border-box;
    }

    .save-btn,
    .delete-btn {
      padding: 5px 10px;
      font-size: 12px;
      border: none;
      border-radius: 4px;
      cursor: pointer;
      width: 100%;
    }

    .save-btn {
      background-color: #007bff;
      color: #fff;
      margin-bottom: 4px;
    }

    .export-btn {
      background-color: #28a745;
      color: white;
      border: none;
      padding: 6px 12px;
      margin-left: 5px;
      border-radius: 4px;
      font-size: 13px;
      cursor: pointer;
    }

    .export-btn:hover {
      background-color: #218838;
    }


    .delete-btn {
      background-color: #dc3545;
      color: #fff;
    }

    @media screen and (max-width: 768px) {
      .search-container input {
        width: 100%;
        margin-top: 10px;
      }

      table {
        font-size: 12px;
      }
    }
  </style>

  <script>
    function filterTable() {
      const input = document.getElementById("searchInput").value.toLowerCase();
      const rows = document.querySelectorAll("#userTable tbody tr");

      rows.forEach(row => {
        const email = row.querySelector(".email")?.textContent.toLowerCase() || '';
        const contact = row.querySelector(".contact")?.textContent.toLowerCase() || '';
        const fullname = row.querySelector(".fullname")?.textContent.toLowerCase() || '';

        if (email.includes(input) || contact.includes(input) || fullname.includes(input)) {
          row.style.display = "";
        } else {
          row.style.display = "none";
        }
      }
    
    );
    }
    function downloadFile(filename, content) {
    const blob = new Blob([content], { type: 'text/csv;charset=utf-8;' });
    const link = document.createElement('a');
    if (link.download !== undefined) {
      const url = URL.createObjectURL(blob);
      link.setAttribute('href', url);
      link.setAttribute('download', filename);
      document.body.appendChild(link);
      link.click();
      document.body.removeChild(link);
    }
  }

  function exportTableToCSV(filename) {
  const rows = document.querySelectorAll("#userTable tr");
  let csv = [];

  rows.forEach(row => {
    let cols = row.querySelectorAll("td, th");
    let rowData = [];

    cols.forEach((col, index) => {
      // Skip last column (Action)
      if (index === cols.length - 1) return;

      // If select, get selected text
      const select = col.querySelector("select");
      if (select) {
        rowData.push('"' + select.options[select.selectedIndex].text.replace(/"/g, '""') + '"');
      } 
      // If input, get value
      else if (col.querySelector("input[type='text']")) {
        rowData.push('"' + col.querySelector("input[type='text']").value.replace(/"/g, '""') + '"');
      } 
      // Otherwise plain text
      else {
        rowData.push('"' + col.innerText.replace(/"/g, '""') + '"');
      }
    });

    csv.push(rowData.join(","));
  });

  downloadFile(filename, csv.join("\n"));
}


  function exportTableToExcel(filename) {
  const table = document.getElementById("userTable").cloneNode(true);

  // Remove Action column (last column) from all rows
  table.querySelectorAll("tr").forEach(row => {
    row.deleteCell(row.cells.length - 1);
  });

  // Replace selects with selected text
  table.querySelectorAll("select").forEach(select => {
    const selectedText = select.options[select.selectedIndex].text;
    select.parentNode.textContent = selectedText;
  });

  // Replace inputs with their value
  table.querySelectorAll("input[type='text']").forEach(input => {
    input.parentNode.textContent = input.value;
  });

  const tableHTML = table.outerHTML.replace(/ /g, '%20');
  const link = document.createElement("a");
  link.href = 'data:application/vnd.ms-excel,' + tableHTML;
  link.download = filename;
  link.click();
}

  </script>
</head>

<body>

  <!-- Poster -->
  <!-- <div class="poster">
    <img src="https://myhotposters.com/cdn/shop/files/mL7396_1024x1024.jpg?v=1748531012" alt="FC 25 Poster">
  </div> -->

  <!-- Main Content -->
  <div class="content">
    <h2>
      <%= tournament.tournament_name %>
    </h2>

    <div class="search-container">
      <input type="text" id="searchInput" onkeyup="filterTable()"
        placeholder="Search by email, contact, or full name..."><br><br>
      <button class="export-btn" onclick="exportTableToCSV('registered_users.csv')">Export CSV</button>
      <button class="export-btn" onclick="exportTableToExcel('registered_users.xlsx')">Export Excel</button>
    </div>


    <div class="table-container">
      <table id="userTable">
        <thead>
          <tr>
            <th>Email</th>
            <th>Contact</th>
            <th>Date of Birth</th>
            <th>Instagram</th>
            <th>Full Name</th>
            <th>Team Name</th>
            <th>Location</th>
            <th>Action</th>
          </tr>
        </thead>
        <tbody>
          <% Object.entries(registered).forEach(([userId, users])=> { %>
            <% users.forEach((user)=> { %>
              <tr>
                <td class="email">
                  <%= user.username %>
                </td>
                <td class="contact">
                  <%= user.contact %>
                </td>
                <td>
                  <%= user.dob ? user.dob.slice(0, 10) : '-' %>
                </td>
                <td>
                  <%= user.insta_id || '-' %>
                </td>
                <td class="fullname">
                  <%= user.full_name || '-' %>
                </td>
                <td>
                  <form method="POST" action="/tournament/<%= tournament._id %>/edit/<%= userId %>">
                    <input type="text" name="team_name" value="<%= user.team_name || '' %>" />
                </td>
                <td>
                  <% if (availableLocations) { %>
                    <select name="selectedLocation">
                      <option value="" <%=!user.selectedLocation ? 'selected' : '' %>>Select Option</option>
                      <% for (let [loc, count] of availableLocations.entries()) { %>
                        <option value="<%= loc %>" <%=user.selectedLocation===loc ? 'selected' : '' %>>
                          <%= loc %> (<%= count %>)
                        </option>
                        <% } %>
                    </select>
                    <% } else { %>
                      <select disabled>
                        <option>No locations available</option>
                      </select>
                      <% } %>
                </td>
                <td>
                  <button type="submit" class="save-btn">Update</button>
                  </form>
                  <form method="POST" action="/tournament/<%= tournament._id %>/delete/<%= userId %>"
                    onsubmit="return confirm('Are you sure you want to delete this user?')">
                    <button type="submit" class="delete-btn">Delete</button>
                  </form>
                </td>
              </tr>
              <% }) %>
                <% }) %>
        </tbody>
      </table>
    </div>
  </div>

</body>

</html>